<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä½œä¸š - æ— éšœç¢AIå­¦ä¹ å¹³å°</title>
    
    <style>
        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #212121;
            --text-secondary: #666666;
            --accent-color: #1a73e8;
            --success-color: #34a853;
            --warning-color: #fbbc04;
            --error-color: #ea4335;
            --border-color: #e0e0e0;
            
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
                         "Microsoft YaHei", sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            min-height: 100vh;
        }
        
        /* ==================== é¡¶éƒ¨å¯¼èˆªæ  - çº¿æ€§å¸ƒå±€ ==================== */
        .top-nav {
            background-color: var(--accent-color);
            color: white;
            padding: var(--spacing-lg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .user-mode-badge {
            background-color: rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            display: block;
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .nav-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-btn {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 56px;
            text-align: left;
            width: 100%;
        }

        .nav-btn:hover {
            background-color: rgba(255,255,255,0.3);
            transform: translateX(4px);
        }

        .nav-btn:focus {
            outline: 3px solid white;
            outline-offset: 2px;
        }
        
        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--spacing-xl) var(--spacing-md);
        }
        
        /* ==================== å¡ç‰‡æ ·å¼ ==================== */
        .card {
            background-color: var(--bg-primary);
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: var(--spacing-lg);
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }
        
        /* ==================== è¡¨å•æ ·å¼ ==================== */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }
        
        .form-input,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-sm);
            font-size: 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* ==================== æŒ‰é’®æ ·å¼ ==================== */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 40px;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1557b0;
        }
        
        /* ==================== æ–‡ä»¶ä¸Šä¼ æ ·å¼ ==================== */
        .file-upload-area {
            display: block;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: var(--spacing-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: transparent;
        }

        .file-upload-area:hover {
            border-color: var(--accent-color);
            background-color: rgba(26, 115, 232, 0.05);
        }

        .file-upload-area:focus {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
            border-color: var(--accent-color);
        }
        
        .file-input {
            display: none;
        }
        
        .file-preview {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* ==================== ä½œä¸šåˆ—è¡¨æ ·å¼ ==================== */
        .homework-list {
            list-style: none;
        }
        
        .homework-item {
            background-color: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .homework-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }
        
        .homework-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        
        .homework-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .homework-link {
            display: inline-block;
            margin-top: var(--spacing-sm);
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .homework-link:hover {
            text-decoration: underline;
        }
        
        
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: var(--spacing-md);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s;
        }

        /* ==================== ç”¨æˆ·æ¨¡å¼æç¤º ==================== */
        .mode-notice {
            background-color: #e3f2fd;
            border-left: 4px solid var(--accent-color);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            border-radius: 4px;
        }

        .mode-notice-title {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: var(--spacing-xs);
        }

        /* ==================== è§†éšœç”¨æˆ·ä¸“ç”¨æ ·å¼ ==================== */
        .visual-impaired-layout {
            display: none;
        }

        .visual-impaired-layout.active {
            display: block;
        }

        .hearing-impaired-layout {
            display: none;
        }

        .hearing-impaired-layout.active {
            display: block;
        }

        /* è§†éšœç”¨æˆ·ï¼šçº¿æ€§æ’å¸ƒæ ·å¼ */
        .vi-homework-item {
            background-color: var(--bg-primary);
            border: 4px solid var(--accent-color);
            border-radius: 16px;
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .vi-homework-number {
            display: inline-block;
            width: 60px;
            height: 60px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 60px;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: var(--spacing-md);
        }

        .vi-homework-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
        }

        .vi-homework-desc {
            font-size: 24px;
            line-height: 1.8;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
        }

        .vi-homework-meta {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }

        .vi-btn {
            width: 100%;
            padding: var(--spacing-xl);
            font-size: 28px;
            font-weight: 700;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px;
            margin-bottom: var(--spacing-md);
        }

        .vi-btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .vi-btn-primary:hover,
        .vi-btn-primary:focus {
            background-color: #1557b0;
            transform: scale(1.02);
        }

        .vi-btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 3px solid var(--border-color);
        }

        .vi-btn-secondary:hover,
        .vi-btn-secondary:focus {
            background-color: var(--border-color);
        }

        .vi-section-title {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: var(--spacing-xl);
            text-align: center;
        }

        .vi-form-group {
            margin-bottom: var(--spacing-xl);
        }

        .vi-form-label {
            display: block;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }

        .vi-form-input,
        .vi-form-textarea,
        .vi-form-select {
            width: 100%;
            padding: var(--spacing-lg);
            font-size: 22px;
            border: 3px solid var(--border-color);
            border-radius: 12px;
            transition: border-color 0.2s;
        }

        .vi-form-input:focus,
        .vi-form-textarea:focus,
        .vi-form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        .vi-form-textarea {
            min-height: 150px;
            resize: vertical;
        }

        .vi-file-upload-area {
            display: block;
            border: 4px dashed var(--accent-color);
            border-radius: 16px;
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: rgba(26, 115, 232, 0.05);
        }

        .vi-file-upload-area:hover {
            background-color: rgba(26, 115, 232, 0.1);
            transform: scale(1.01);
        }

        .vi-file-upload-area:focus {
            outline: 4px solid var(--accent-color);
            outline-offset: 3px;
            background-color: rgba(26, 115, 232, 0.15);
        }

        .vi-file-upload-icon {
            font-size: 80px;
            margin-bottom: var(--spacing-md);
        }

        .vi-file-upload-text {
            font-size: 24px;
            font-weight: 600;
        }

        .vi-file-preview {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-lg);
            background-color: var(--bg-secondary);
            border-radius: 12px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  - çº¿æ€§å¸ƒå±€ -->
    <nav class="top-nav" role="navigation" aria-label="ä¸»å¯¼èˆª">
        <h1 class="nav-title">ğŸ“ æˆ‘çš„ä½œä¸š</h1>
        <div class="user-mode-badge" id="userModeBadge" role="status" aria-live="polite">
            æ­£åœ¨åŠ è½½ç”¨æˆ·æ¨¡å¼...
        </div>
        <div class="nav-buttons">
            <button class="nav-btn" id="returnBtn" aria-label="è¿”å›è¯¾ç¨‹é€‰æ‹©é¡µé¢">
                â† è¿”å›è¯¾ç¨‹é€‰æ‹©
            </button>
        </div>
    </nav>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- å¬éšœç”¨æˆ·å¸ƒå±€ -->
        <div class="hearing-impaired-layout" id="hearingImpairedLayout">
            <!-- ç”¨æˆ·æ¨¡å¼æç¤º -->
            <div class="mode-notice">
                <div class="mode-notice-title">ğŸ‘‚ å¬éšœç”¨æˆ·ä¸“ç”¨ç•Œé¢</div>
                <p>æ­¤ç•Œé¢ä¸“ä¸ºå¬éšœç”¨æˆ·ä¼˜åŒ–ï¼Œæä¾›æ¸…æ™°çš„è§†è§‰ä¿¡æ¯å±•ç¤ºã€‚</p>
            </div>

            <!-- ä½œä¸šåˆ—è¡¨ -->
            <div class="card">
                <h2 class="card-title">ğŸ“‹ å¾…å®Œæˆä½œä¸š</h2>
                <ul class="homework-list" id="homeworkList">
                    <!-- ä½œä¸šå°†åŠ¨æ€åŠ è½½ -->
                </ul>
            </div>

            <!-- ä½œä¸šæäº¤è¡¨å• -->
            <div class="card">
                <h2 class="card-title">ğŸ“¤ æäº¤ä½œä¸š</h2>
                <form id="submissionForm">
                    <div class="form-group">
                        <label class="form-label" for="homeworkSelect">é€‰æ‹©ä½œä¸š *</label>
                        <select id="homeworkSelect" class="form-input" required>
                            <option value="">è¯·é€‰æ‹©è¦æäº¤çš„ä½œä¸š</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="submissionNote">ä½œä¸šå†…å®¹ *</label>
                        <textarea id="submissionNote" class="form-textarea"
                                  placeholder="è¯·è¾“å…¥æ‚¨çš„ä½œä¸šå†…å®¹ã€ä½¿ç”¨çš„AIå·¥å…·ã€åˆ›ä½œè¿‡ç¨‹ç­‰..." required></textarea>
                        <p class="form-hint">å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—å†…å®¹ï¼Œæˆ–ä¸Šä¼ æ–‡ä»¶</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="fileUploadLabel">ä¸Šä¼ ä½œä¸šæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                        <label for="fileInput" class="file-upload-area" role="button" tabindex="0"
                               aria-labelledby="fileUploadLabel"
                               onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();document.getElementById('fileInput').click();}">
                            <div style="font-size: 48px; margin-bottom: 8px;" aria-hidden="true">ğŸ“</div>
                            <div>ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶ï¼ˆæ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€HTMLç­‰æ ¼å¼ï¼‰</div>
                        </label>
                        <input type="file" id="fileInput" class="file-input"
                               accept="image/*,video/*,.html,.htm"
                               onchange="handleFileUpload(this)"
                               aria-describedby="fileUploadLabel">
                        <div id="filePreview" class="file-preview" style="display:none;"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">æäº¤ä½œä¸š</button>
                </form>
            </div>
        </div>

        <!-- è§†éšœç”¨æˆ·å¸ƒå±€ -->
        <div class="visual-impaired-layout" id="visualImpairedLayout">
            <h1 class="vi-section-title">ğŸ“‹ æˆ‘çš„ä½œä¸šåˆ—è¡¨</h1>

            <div id="viHomeworkList">
                <!-- ä½œä¸šå°†åŠ¨æ€åŠ è½½ -->
            </div>

            <h1 class="vi-section-title">ğŸ“¤ æäº¤ä½œä¸š</h1>

            <form id="viSubmissionForm">
                <div class="vi-form-group">
                    <label class="vi-form-label" for="viHomeworkSelect">é€‰æ‹©è¦æäº¤çš„ä½œä¸š *</label>
                    <select id="viHomeworkSelect" class="vi-form-select" required>
                        <option value="">è¯·é€‰æ‹©ä½œä¸š</option>
                    </select>
                </div>

                <div class="vi-form-group">
                    <label class="vi-form-label" for="viSubmissionNote">ä½œä¸šå†…å®¹ *</label>
                    <textarea id="viSubmissionNote" class="vi-form-textarea"
                              placeholder="è¯·è¾“å…¥æ‚¨çš„ä½œä¸šå†…å®¹ã€ä½¿ç”¨çš„AIå·¥å…·ã€åˆ›ä½œè¿‡ç¨‹ç­‰..." required></textarea>
                    <p style="font-size: 18px; margin-top: 8px; color: var(--text-secondary);">
                        å¯ä»¥ç›´æ¥è¾“å…¥æ–‡å­—å†…å®¹ï¼Œæˆ–ä¸Šä¼ æ–‡ä»¶
                    </p>
                </div>

                <div class="vi-form-group">
                    <label class="vi-form-label" id="viFileUploadLabel">ä¸Šä¼ ä½œä¸šæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                    <label for="viFileInput" class="vi-file-upload-area" role="button" tabindex="0"
                           aria-labelledby="viFileUploadLabel"
                           onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();document.getElementById('viFileInput').click();}">
                        <div class="vi-file-upload-icon" aria-hidden="true">ğŸ“</div>
                        <div class="vi-file-upload-text">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</div>
                        <div style="font-size: 18px; margin-top: 8px; color: var(--text-secondary);">
                            æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€HTMLç­‰æ ¼å¼
                        </div>
                    </label>
                    <input type="file" id="viFileInput" class="file-input"
                           accept="image/*,video/*,.html,.htm"
                           onchange="handleViFileUpload(this)"
                           aria-describedby="viFileUploadLabel">
                    <div id="viFilePreview" class="vi-file-preview" style="display:none;"></div>
                </div>

                <button type="submit" class="vi-btn vi-btn-primary">æäº¤ä½œä¸š</button>
            </form>
        </div>
    </div>

    <script>
        // ==================== ç”¨æˆ·æ¨¡å¼æ£€æµ‹ ====================
        const urlParams = new URLSearchParams(window.location.search);
        const userMode = urlParams.get('mode') || localStorage.getItem('userMode') || 'visual';
        localStorage.setItem('userMode', userMode);

        // ==================== æ›´æ–°ç”¨æˆ·æ¨¡å¼å¾½ç«  ====================
        function updateUserModeBadge() {
            const badge = document.getElementById('userModeBadge');
            if (userMode === 'hearing') {
                badge.textContent = 'ğŸ‘‚ å¬éšœç”¨æˆ·æ¨¡å¼';
            } else if (userMode === 'visual') {
                badge.textContent = 'ğŸ‘ï¸ è§†éšœç”¨æˆ·æ¨¡å¼';
            } else if (userMode === 'teacher') {
                badge.textContent = 'ğŸ‘¨â€ğŸ« æ•™å¸ˆæ¨¡å¼';
            } else {
                badge.textContent = 'ğŸ‘¤ æ™®é€šæ¨¡å¼';
            }
        }

        // ==================== ç•Œé¢åˆ‡æ¢ ====================
        function switchLayout() {
            const hearingLayout = document.getElementById('hearingImpairedLayout');
            const visualLayout = document.getElementById('visualImpairedLayout');

            if (userMode === 'hearing') {
                hearingLayout.classList.add('active');
                visualLayout.classList.remove('active');

                // å¯ç”¨å¬éšœæ¨¡å¼è¡¨å•çš„requiredå±æ€§
                document.getElementById('homeworkSelect').required = true;
                document.getElementById('submissionNote').required = true;

                // ç¦ç”¨è§†éšœæ¨¡å¼è¡¨å•çš„requiredå±æ€§
                document.getElementById('viHomeworkSelect').required = false;
                document.getElementById('viSubmissionNote').required = false;
            } else {
                visualLayout.classList.add('active');
                hearingLayout.classList.remove('active');

                // ç¦ç”¨å¬éšœæ¨¡å¼è¡¨å•çš„requiredå±æ€§
                document.getElementById('homeworkSelect').required = false;
                document.getElementById('submissionNote').required = false;

                // å¯ç”¨è§†éšœæ¨¡å¼è¡¨å•çš„requiredå±æ€§
                document.getElementById('viHomeworkSelect').required = true;
                document.getElementById('viSubmissionNote').required = true;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆ‡æ¢å¸ƒå±€å’Œæ›´æ–°å¾½ç« 
        updateUserModeBadge();
        switchLayout();

        // ==================== è¿”å›æŒ‰é’®åŠŸèƒ½ ====================
        const returnBtn = document.getElementById('returnBtn');
        returnBtn.addEventListener('click', () => {
            window.location.href = `course_selection.html?mode=${userMode}`;
        });

        // ==================== è·å–å½“å‰å­¦ç”ŸID ====================
        function getCurrentStudentId() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            return currentUser ? currentUser.id : 'student_001';
        }

        // ==================== æ£€æŸ¥ä½œä¸šæ˜¯å¦å·²æäº¤ ====================
        function isHomeworkSubmitted(homeworkId) {
            const submissions = JSON.parse(localStorage.getItem('homeworkSubmissions') || '{}');
            const studentId = getCurrentStudentId();

            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥å­¦ç”Ÿå¯¹è¯¥ä½œä¸šçš„æäº¤è®°å½•
            return Object.values(submissions).some(
                sub => sub.studentId === studentId && sub.homeworkId === homeworkId
            );
        }

        // ==================== åŠ¨æ€åŠ è½½ä½œä¸š ====================
        async function loadHomeworkFromAPI() {
            try {
                const response = await fetch('http://localhost:3000/api/homework');
                const result = await response.json();

                if (result.success && result.homework) {
                    // è¿‡æ»¤æ‰å·²æäº¤çš„ä½œä¸š
                    const unsubmittedHomework = result.homework.filter(hw => !isHomeworkSubmitted(hw.id));

                    if (userMode === 'hearing') {
                        // å¬éšœç”¨æˆ·å¸ƒå±€
                        const homeworkList = document.getElementById('homeworkList');
                        const homeworkSelect = document.getElementById('homeworkSelect');

                        homeworkList.innerHTML = '';
                        homeworkSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦æäº¤çš„ä½œä¸š</option>';

                        if (unsubmittedHomework.length === 0) {
                            homeworkList.innerHTML = '<p style="text-align: center; color: var(--success-color); padding: 20px;">âœ“ æ‰€æœ‰ä½œä¸šå·²æäº¤ï¼</p>';
                        } else {
                            unsubmittedHomework.forEach(hw => {
                                renderHomeworkItem(hw, homeworkList);
                                addHomeworkOption(hw, homeworkSelect);
                            });
                        }
                    } else {
                        // è§†éšœç”¨æˆ·å¸ƒå±€
                        const viHomeworkList = document.getElementById('viHomeworkList');
                        const viHomeworkSelect = document.getElementById('viHomeworkSelect');

                        viHomeworkList.innerHTML = '';
                        viHomeworkSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä½œä¸š</option>';

                        if (unsubmittedHomework.length === 0) {
                            viHomeworkList.innerHTML = '<div class="vi-homework-item"><h2 class="vi-homework-title">âœ“ æ‰€æœ‰ä½œä¸šå·²æäº¤ï¼</h2></div>';
                        } else {
                            unsubmittedHomework.forEach((hw, index) => {
                                renderViHomeworkItem(hw, viHomeworkList, index + 1);
                                addHomeworkOption(hw, viHomeworkSelect);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä½œä¸šå¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å¬éšœç”¨æˆ·ä½œä¸šé¡¹
        function renderHomeworkItem(homework, container) {
            const li = document.createElement('li');
            li.className = 'homework-item';

            const deadline = homework.deadline ? new Date(homework.deadline).toLocaleDateString('zh-CN') : 'æ— æˆªæ­¢æ—¥æœŸ';
            const aiToolLink = homework.aiToolLinks && homework.aiToolLinks.length > 0
                ? homework.aiToolLinks[0].url
                : '#';
            const aiToolName = homework.aiToolLinks && homework.aiToolLinks.length > 0
                ? homework.aiToolLinks[0].name
                : 'AIå·¥å…·';

            li.innerHTML = `
                <h3 class="homework-title">${homework.title}</h3>
                <p class="homework-desc">${homework.description}</p>
                <p class="homework-meta">æˆªæ­¢æ—¥æœŸï¼š${deadline} | çŠ¶æ€ï¼šæœªæäº¤</p>
                ${aiToolLink !== '#' ? `<a href="${aiToolLink}" class="homework-link" target="_blank" rel="noopener">
                    ğŸ”— å‰å¾€${aiToolName}
                </a>` : ''}
            `;

            container.appendChild(li);
        }

        // æ¸²æŸ“è§†éšœç”¨æˆ·ä½œä¸šé¡¹
        function renderViHomeworkItem(homework, container, number) {
            const div = document.createElement('div');
            div.className = 'vi-homework-item';

            const deadline = homework.deadline ? new Date(homework.deadline).toLocaleDateString('zh-CN') : 'æ— æˆªæ­¢æ—¥æœŸ';
            const aiToolLink = homework.aiToolLinks && homework.aiToolLinks.length > 0
                ? homework.aiToolLinks[0].url
                : '#';
            const aiToolName = homework.aiToolLinks && homework.aiToolLinks.length > 0
                ? homework.aiToolLinks[0].name
                : 'AIå·¥å…·';

            div.innerHTML = `
                <div class="vi-homework-number">${number}</div>
                <h2 class="vi-homework-title">${homework.title}</h2>
                <p class="vi-homework-desc">${homework.description}</p>
                <p class="vi-homework-meta">ğŸ“… æˆªæ­¢æ—¥æœŸï¼š${deadline}</p>
                <p class="vi-homework-meta">ğŸ“Š çŠ¶æ€ï¼šæœªæäº¤</p>
                ${aiToolLink !== '#' ? `<button class="vi-btn vi-btn-secondary" onclick="window.open('${aiToolLink}', '_blank')">
                    ğŸ”— å‰å¾€${aiToolName}
                </button>` : ''}
            `;

            container.appendChild(div);
        }

        // æ·»åŠ ä½œä¸šé€‰é¡¹
        function addHomeworkOption(homework, select) {
            const option = document.createElement('option');
            option.value = homework.id;
            option.textContent = homework.title;
            select.appendChild(option);
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ä½œä¸š
        loadHomeworkFromAPI();

        // ==================== æ–‡ä»¶ä¸Šä¼ å¤„ç† ====================
        function handleFileUpload(input) {
            const file = input.files[0];
            const preview = document.getElementById('filePreview');

            if (file) {
                preview.style.display = 'block';
                preview.innerHTML = `
                    <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong> ${file.name}
                    <br><strong>æ–‡ä»¶å¤§å°ï¼š</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
                `;
            }
        }

        function handleViFileUpload(input) {
            const file = input.files[0];
            const preview = document.getElementById('viFilePreview');

            if (file) {
                preview.style.display = 'block';
                preview.innerHTML = `
                    <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong> ${file.name}
                    <br><strong>æ–‡ä»¶å¤§å°ï¼š</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
                `;
            }
        }

        // ==================== é€šçŸ¥åŠŸèƒ½ ====================
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'assertive');

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ==================== ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ ====================
        async function uploadHomeworkFile(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('http://localhost:3000/api/upload/homework', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    return {
                        fileUrl: result.fileUrl,
                        fileName: result.originalName,
                        mimetype: result.mimetype
                    };
                } else {
                    throw new Error(result.message || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                throw error;
            }
        }

        // ==================== ä¿å­˜ä½œä¸šæäº¤è®°å½•åˆ°æœåŠ¡å™¨ ====================
        async function saveHomeworkSubmission(homeworkId, fileInfo, note) {
            try {
                const studentId = getCurrentStudentId();

                const submissionData = {
                    homeworkId: homeworkId,
                    studentId: studentId,
                    note: note,
                    fileUrl: fileInfo ? fileInfo.fileUrl : '',
                    fileName: fileInfo ? fileInfo.fileName : 'çº¯æ–‡å­—æäº¤',
                    mimetype: fileInfo ? fileInfo.mimetype : '',
                    submittedAt: new Date().toISOString()
                };

                const response = await fetch('http://localhost:3000/api/submissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submissionData)
                });

                const result = await response.json();

                if (result.success) {
                    return true;
                } else {
                    throw new Error(result.message || 'æäº¤ä½œä¸šå¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜æäº¤è®°å½•å¤±è´¥:', error);
                throw error;
            }
        }

        // ==================== è¡¨å•æäº¤ ====================
        // å¬éšœç”¨æˆ·è¡¨å•æäº¤
        const submissionForm = document.getElementById('submissionForm');
        if (submissionForm) {
            submissionForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const homeworkSelect = document.getElementById('homeworkSelect').value;
                const note = document.getElementById('submissionNote').value.trim();
                const file = document.getElementById('fileInput').files[0];

                if (!homeworkSelect) {
                    alert('è¯·é€‰æ‹©ä½œä¸šï¼');
                    return;
                }

                if (!note && !file) {
                    alert('è¯·è¾“å…¥ä½œä¸šå†…å®¹æˆ–ä¸Šä¼ æ–‡ä»¶ï¼');
                    return;
                }

                try {
                    // æ˜¾ç¤ºåŠ è½½æç¤º
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'æäº¤ä¸­...';
                    submitBtn.disabled = true;

                    let fileInfo = null;

                    // å¦‚æœæœ‰æ–‡ä»¶ï¼Œå…ˆä¸Šä¼ æ–‡ä»¶
                    if (file) {
                        fileInfo = await uploadHomeworkFile(file);
                    }

                    // ä¿å­˜æäº¤è®°å½•åˆ°æœåŠ¡å™¨
                    await saveHomeworkSubmission(homeworkSelect, fileInfo, note);

                    showNotification('ä½œä¸šæäº¤æˆåŠŸï¼');

                    // é‡ç½®è¡¨å•
                    e.target.reset();
                    document.getElementById('filePreview').style.display = 'none';

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;

                    // å»¶è¿Ÿé‡æ–°åŠ è½½ä½œä¸šåˆ—è¡¨ï¼Œé¿å…DOMæ“ä½œå†²çª
                    setTimeout(() => {
                        loadHomeworkFromAPI();
                    }, 500);
                } catch (error) {
                    console.error('æäº¤ä½œä¸šå¤±è´¥:', error);
                    alert('æäº¤ä½œä¸šå¤±è´¥ï¼š' + error.message);

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'æäº¤ä½œä¸š';
                    submitBtn.disabled = false;
                }
            });
        }

        // è§†éšœç”¨æˆ·è¡¨å•æäº¤
        const viSubmissionForm = document.getElementById('viSubmissionForm');
        if (viSubmissionForm) {
            viSubmissionForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const homeworkSelect = document.getElementById('viHomeworkSelect').value;
                const note = document.getElementById('viSubmissionNote').value.trim();
                const file = document.getElementById('viFileInput').files[0];

                if (!homeworkSelect) {
                    alert('è¯·é€‰æ‹©ä½œä¸šï¼');
                    return;
                }

                if (!note && !file) {
                    alert('è¯·è¾“å…¥ä½œä¸šå†…å®¹æˆ–ä¸Šä¼ æ–‡ä»¶ï¼');
                    return;
                }

                try {
                    // æ˜¾ç¤ºåŠ è½½æç¤º
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'æäº¤ä¸­...';
                    submitBtn.disabled = true;

                    let fileInfo = null;

                    // å¦‚æœæœ‰æ–‡ä»¶ï¼Œå…ˆä¸Šä¼ æ–‡ä»¶
                    if (file) {
                        fileInfo = await uploadHomeworkFile(file);
                    }

                    // ä¿å­˜æäº¤è®°å½•åˆ°æœåŠ¡å™¨
                    await saveHomeworkSubmission(homeworkSelect, fileInfo, note);

                    showNotification('ä½œä¸šæäº¤æˆåŠŸï¼');

                    // é‡ç½®è¡¨å•
                    e.target.reset();
                    document.getElementById('viFilePreview').style.display = 'none';

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;

                    // å»¶è¿Ÿé‡æ–°åŠ è½½ä½œä¸šåˆ—è¡¨ï¼Œé¿å…DOMæ“ä½œå†²çª
                    setTimeout(() => {
                        loadHomeworkFromAPI();
                    }, 500);
                } catch (error) {
                    console.error('æäº¤ä½œä¸šå¤±è´¥:', error);
                    alert('æäº¤ä½œä¸šå¤±è´¥ï¼š' + error.message);

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'æäº¤ä½œä¸š';
                    submitBtn.disabled = false;
                }
            });
        }

    </script>
</body>
</html>
