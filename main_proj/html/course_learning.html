<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="æ— éšœç¢AIå­¦ä¹ å¹³å° - è¯¾ç¨‹å­¦ä¹ ">
    <title>æ— éšœç¢AIå­¦ä¹ å¹³å° - è¯¾ç¨‹å­¦ä¹ </title>

    <style>
        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #212121;
            --text-secondary: #666666;
            --accent-color: #1a9d95;
            --success-color: #34a853;
            --error-color: #ea4335;
            --border-color: #e0e0e0;
            --user-msg-bg: #e3f2fd;
            --ai-msg-bg: #f1f8e9;

            /* å­—ä½“å¤§å° - é»˜è®¤æ­£å¸¸å¤§å° */
            --font-size-base: 16px;
            --font-scale: 1;

            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        /* è§†éšœç”¨æˆ·æ¨¡å¼ - å¤§å­—ä½“ */
        body.visual-mode {
            --font-scale: 2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
                         "Microsoft YaHei", sans-serif;
            font-size: calc(var(--font-size-base) * var(--font-scale));
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ==================== é¡¶éƒ¨å·¥å…·æ  - çº¿æ€§å¸ƒå±€ ==================== */
        .top-toolbar {
            background-color: var(--accent-color);
            color: white;
            padding: var(--spacing-lg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toolbar-title {
            font-size: calc(20px * var(--font-scale));
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .toolbar-btn {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: calc(16px * var(--font-scale));
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }

        .toolbar-btn:hover {
            background-color: rgba(255,255,255,0.3);
        }

        .toolbar-btn:focus {
            outline: 3px solid white;
            outline-offset: 2px;
        }

        /* ==================== è¿›åº¦æ¡ ==================== */
        .progress-bar-wrapper {
            background-color: rgba(255,255,255,0.2);
            height: 4px;
            width: 100%;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: white;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            flex: 1;
            overflow-y: auto;
            max-width: 800px;
            margin: 0 auto;
            padding: var(--spacing-md);
            width: 100%;
        }

        /* ==================== é¡µé¢å¤´éƒ¨ ==================== */
        .header {
            text-align: center;
            padding: var(--spacing-lg) 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: var(--spacing-lg);
        }

        .header h1 {
            font-size: calc(28px * var(--font-scale));
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: var(--spacing-sm);
        }

        .header p {
            font-size: calc(16px * var(--font-scale));
            color: var(--text-secondary);
        }

        /* ==================== è§†é¢‘æ’­æ”¾å™¨æ ·å¼ ==================== */
        .video-section {
            display: none;
            background-color: var(--bg-secondary);
            border: 3px solid var(--accent-color);
            border-radius: 12px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .video-section.visible {
            display: block;
        }

        .video-title {
            font-size: calc(20px * var(--font-scale));
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        /* ==================== è§†é¢‘é“¾æ¥è¾“å…¥æ ·å¼ ==================== */
        .video-link-input-section {
            background-color: var(--bg-primary);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .video-link-title {
            font-size: calc(16px * var(--font-scale));
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: var(--spacing-sm);
            text-align: center;
        }

        .video-link-input-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .video-link-input {
            width: 100%;
            padding: var(--spacing-md);
            font-size: calc(15px * var(--font-scale));
            font-family: inherit;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        .video-link-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(26, 157, 149, 0.1);
        }

        .video-link-load-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: calc(15px * var(--font-scale));
            font-weight: 600;
            color: white;
            background-color: var(--accent-color);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: calc(44px * var(--font-scale));
        }

        .video-link-load-btn:hover,
        .video-link-load-btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .video-link-load-btn:active {
            transform: translateY(0);
        }

        .video-link-hint {
            font-size: calc(13px * var(--font-scale));
            color: var(--text-secondary);
            text-align: center;
            margin-top: var(--spacing-xs);
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background-color: #000000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: var(--spacing-md);
        }

        .video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .video-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-controls {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .video-progress-bar {
            width: 100%;
            height: calc(8px * var(--font-scale));
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .video-progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        .video-buttons {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            flex-wrap: wrap;
        }

        .video-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: calc(14px * var(--font-scale));
            font-weight: 600;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: calc(40px * var(--font-scale));
        }

        .video-btn:hover,
        .video-btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .video-time-display {
            text-align: center;
            font-size: calc(14px * var(--font-scale));
            color: var(--text-secondary);
            margin-top: var(--spacing-sm);
        }

        /* ==================== éŸ³é‡æ§åˆ¶æ ·å¼ ==================== */
        .volume-control {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            background-color: var(--bg-secondary);
            border-radius: 8px;
        }

        .volume-control label {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-primary);
            font-weight: 600;
        }

        .volume-control input[type="range"] {
            width: 100%;
            height: calc(8px * var(--font-scale));
        }

        /* ==================== ä»»åŠ¡å¡ç‰‡æ ·å¼ ==================== */
        /* ==================== ä»»åŠ¡å¡ç‰‡ - çº¿æ€§å¸ƒå±€ ==================== */
        .task-card {
            background-color: var(--bg-primary);
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: border-color 0.2s;
        }

        .task-card.active {
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(26, 157, 149, 0.2);
        }

        .task-card.completed {
            border-color: var(--success-color);
            opacity: 0.8;
        }

        .task-title {
            font-size: calc(20px * var(--font-scale));
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .task-description {
            font-size: calc(16px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: var(--spacing-md);
        }

        .task-ai-hint {
            font-size: calc(15px * var(--font-scale));
            color: var(--accent-color);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: rgba(26, 157, 149, 0.1);
            border-radius: 6px;
        }
        
        .task-actions {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ==================== ä»»åŠ¡æäº¤åŒºåŸŸæ ·å¼ ==================== */
        .task-submission-area {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 2px solid var(--border-color);
        }

        .task-submission-label {
            font-size: calc(15px * var(--font-scale));
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            display: block;
        }

        .task-submission-textarea {
            width: 100%;
            min-height: calc(120px * var(--font-scale));
            padding: var(--spacing-md);
            font-size: calc(15px * var(--font-scale));
            font-family: inherit;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .task-submission-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(26, 157, 149, 0.1);
        }

        .task-submit-btn {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: calc(15px * var(--font-scale));
            font-weight: 600;
            color: white;
            background-color: var(--accent-color);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-submit-btn:hover,
        .task-submit-btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .task-status {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            font-size: calc(14px * var(--font-scale));
            font-weight: 600;
            border-radius: 6px;
            text-align: center;
        }

        .task-status.completed {
            color: var(--success-color);
            background-color: rgba(76, 175, 80, 0.1);
            border: 2px solid var(--success-color);
        }

        .task-status.pending {
            color: var(--text-secondary);
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
        }

        /* ==================== æŒ‰é’®æ ·å¼ ==================== */
        .btn {
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: calc(16px * var(--font-scale));
            font-weight: 600;
            border: 2px solid;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: calc(48px * var(--font-scale));
            flex: 1;
            min-width: 120px;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .btn-primary:hover,
        .btn-primary:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }
        
        .btn-secondary {
            background-color: var(--bg-primary);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-secondary:hover,
        .btn-secondary:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ==================== å®Œæˆè¯¾ç¨‹æŒ‰é’®æ ·å¼ ==================== */
        .complete-course-section {
            display: flex;
            justify-content: center;
            padding: var(--spacing-xl);
            margin-top: var(--spacing-lg);
        }

        .complete-course-btn {
            padding: calc(var(--spacing-md) * 1.5) calc(var(--spacing-xl) * 2);
            font-size: calc(18px * var(--font-scale));
            font-weight: 700;
            color: white;
            background-color: var(--success-color);
            border: 3px solid var(--success-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .complete-course-btn:hover,
        .complete-course-btn:focus {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
            outline: 3px solid var(--success-color);
            outline-offset: 3px;
        }

        .complete-course-btn:active {
            transform: translateY(0);
        }
        
        /* ==================== è¿›åº¦æ¡æ ·å¼ ==================== */
        .progress-section {
            margin-bottom: var(--spacing-lg);
        }
        
        .progress-bar-container {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            height: calc(40px * var(--font-scale));
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--success-color);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: calc(16px * var(--font-scale));
        }
        
        .progress-text {
            text-align: center;
            margin-top: var(--spacing-sm);
            font-size: calc(16px * var(--font-scale));
            color: var(--text-secondary);
        }
        
        /* ==================== é€šçŸ¥æ ·å¼ ==================== */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: var(--spacing-md);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s;
            font-size: calc(16px * var(--font-scale));
        }
        
        .notification.error {
            background-color: var(--error-color);
        }
        
        .notification.info {
            background-color: var(--accent-color);
        }


        /* ==================== å“åº”å¼è®¾è®¡ ==================== */
        @media (max-width: 600px) {
            .container {
                padding: var(--spacing-sm);
            }
            
            .task-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        /* ==================== å­—å¹•æ§åˆ¶é¢æ¿æ ·å¼ ==================== */
        .subtitle-controls {
            background-color: var(--bg-primary);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .subtitle-title {
            font-size: calc(16px * var(--font-scale));
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: var(--spacing-sm);
            text-align: center;
        }

        .subtitle-buttons {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            margin-bottom: var(--spacing-md);
        }

        .subtitle-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: calc(14px * var(--font-scale));
            font-weight: 600;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: calc(40px * var(--font-scale));
        }

        .subtitle-btn.active {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .subtitle-btn:hover,
        .subtitle-btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .subtitle-size-control {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .subtitle-size-control label {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-primary);
            font-weight: 600;
        }

        .subtitle-size-control input[type="range"] {
            width: 100%;
            height: calc(8px * var(--font-scale));
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-color);
            outline: none;
            border-radius: 4px;
        }

        .subtitle-size-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: calc(20px * var(--font-scale));
            height: calc(20px * var(--font-scale));
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
        }

        .subtitle-size-control input[type="range"]::-moz-range-thumb {
            width: calc(20px * var(--font-scale));
            height: calc(20px * var(--font-scale));
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
        }

        /* ==================== å­—å¹•ç”Ÿæˆæ§åˆ¶æ ·å¼ ==================== */
        .subtitle-generation-control {
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .subtitle-status {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            background-color: var(--bg-secondary);
            border-radius: 6px;
            font-size: calc(14px * var(--font-scale));
            color: var(--text-secondary);
        }

        .subtitle-status.active {
            background-color: rgba(26, 157, 149, 0.1);
            color: var(--accent-color);
        }

        .subtitle-status.error {
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--error-color);
        }

        /* ==================== å®æ—¶å­—å¹•æ˜¾ç¤ºæ ·å¼ ==================== */
        .realtime-subtitle-display {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            min-height: 60px;
        }

        .subtitle-text {
            font-size: calc(18px * var(--font-scale));
            color: white;
            text-align: center;
            line-height: 1.6;
        }

        /* è§†éšœæ¨¡å¼ä¸‹éšè—å­—å¹•æ§åˆ¶ */
        body.visual-mode .subtitle-controls {
            display: none;
        }

        /* ==================== å¬éšœæ¨¡å¼æ ·å¼è¦†ç›– ==================== */
        body.hearing-mode .top-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-lg);
        }

        body.hearing-mode .toolbar-title {
            font-size: calc(24px * var(--font-scale));
            margin-bottom: 0;
            text-align: left;
        }

        body.hearing-mode .toolbar-btn {
            width: auto;
            max-width: none;
            margin: 0;
            padding: 10px 20px;
            font-size: calc(15px * var(--font-scale));
        }

    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å·¥å…·æ  - çº¿æ€§å¸ƒå±€ -->
    <nav class="top-toolbar" role="navigation" aria-label="è¯¾ç¨‹å¯¼èˆª">
        <h1 class="toolbar-title" id="courseTitle">è¯¾ç¨‹å­¦ä¹ </h1>
        <button class="toolbar-btn" id="returnBtn" aria-label="è¿”å›è¯¾ç¨‹é€‰æ‹©é¡µé¢">
            â† è¿”å›è¯¾ç¨‹é€‰æ‹©
        </button>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <section class="progress-section" role="region" aria-label="å­¦ä¹ è¿›åº¦">
            <div class="progress-bar-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar" id="progressBar" style="width: 0%;">
                    0%
                </div>
            </div>
            <p class="progress-text" id="progressText">å·²å®Œæˆ 0/0 ä¸ªä»»åŠ¡</p>
        </section>
        
        <!-- è¯¾ç¨‹å¤´éƒ¨ -->
        <header class="course-header" role="banner">
            <h1 class="course-title" id="courseTitleMain">åŠ è½½ä¸­...</h1>
            <p class="course-description" id="courseDescription">æ­£åœ¨åŠ è½½è¯¾ç¨‹å†…å®¹...</p>
        </header>

        <!-- è§†é¢‘æ’­æ”¾å™¨ï¼ˆå¦‚æœè¯¾ç¨‹æœ‰è§†é¢‘ï¼‰ -->
        <section class="video-section" id="videoSection" role="region" aria-label="æ•™å­¦è§†é¢‘">
            <h2 class="video-title">ğŸ“¹ æ•™å­¦è§†é¢‘</h2>

            <!-- è§†é¢‘é“¾æ¥è¾“å…¥åŒºåŸŸ -->
            <div class="video-link-input-section">
                <h3 class="video-link-title">ğŸ”— ä½¿ç”¨é“¾æ¥æ’­æ”¾è§†é¢‘</h3>
                <div class="video-link-input-group">
                    <input
                        type="url"
                        class="video-link-input"
                        id="videoLinkInput"
                        placeholder="è¯·è¾“å…¥è§†é¢‘é“¾æ¥ï¼ˆæ”¯æŒ Bilibiliã€YouTube æˆ–ç›´æ¥è§†é¢‘æ–‡ä»¶ï¼‰"
                        aria-label="è§†é¢‘é“¾æ¥è¾“å…¥æ¡†"
                    >
                    <button class="video-link-load-btn" id="loadVideoLinkBtn" aria-label="åŠ è½½è§†é¢‘é“¾æ¥">
                        åŠ è½½è§†é¢‘
                    </button>
                    <p class="video-link-hint">æ”¯æŒï¼šBilibiliã€YouTube å¹³å°é“¾æ¥ï¼Œæˆ–ç›´æ¥è§†é¢‘æ–‡ä»¶é“¾æ¥ï¼ˆ.mp4ã€.webm ç­‰ï¼‰</p>
                </div>
            </div>

            <div class="video-container">
                <video class="video-player" id="videoPlayer" controls crossorigin="anonymous" style="display: block;">
                    <source id="videoSource" src="" type="video/mp4">
                    <track id="videoSubtitle" kind="subtitles" srclang="zh" label="ä¸­æ–‡" default>
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                </video>
                <iframe class="video-iframe" id="videoIframe" style="display: none;" allowfullscreen></iframe>
            </div>

            <div class="video-controls">
                <!-- å­—å¹•æ§åˆ¶é¢æ¿ï¼ˆä»…å¬éšœæ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                <div class="subtitle-controls">
                    <h3 class="subtitle-title">å­—å¹•æ§åˆ¶</h3>

                    <!-- å­—å¹•ç”Ÿæˆæ§åˆ¶ -->
                    <div class="subtitle-generation-control">
                        <button class="subtitle-btn" id="generateSubtitleBtn" aria-label="ç”Ÿæˆå­—å¹•">
                            ğŸ“ ç”Ÿæˆå­—å¹•
                        </button>
                        <div class="subtitle-status" id="subtitleStatus" style="display: none;">
                            <span id="subtitleStatusText">å‡†å¤‡ä¸­...</span>
                        </div>
                    </div>

                    <div class="subtitle-buttons">
                        <button class="subtitle-btn active" id="showSubtitleBtn" aria-label="æ˜¾ç¤ºå­—å¹•">
                            æ˜¾ç¤ºå­—å¹•
                        </button>
                        <button class="subtitle-btn" id="hideSubtitleBtn" aria-label="éšè—å­—å¹•">
                            éšè—å­—å¹•
                        </button>
                    </div>
                    <div class="subtitle-size-control">
                        <label for="subtitleSizeSlider">å­—å¹•å¤§å°ï¼š<span id="subtitleSizeValue">24</span>px</label>
                        <input type="range" id="subtitleSizeSlider" min="16" max="40" value="24" step="2">
                    </div>
                </div>
            </div>
        </section>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <section class="task-section" role="region" aria-label="å­¦ä¹ ä»»åŠ¡åˆ—è¡¨" id="taskSection">
            <!-- ä»»åŠ¡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </section>

        <!-- å®Œæˆè¯¾ç¨‹æŒ‰é’® -->
        <div class="complete-course-section" role="region" aria-label="è¯¾ç¨‹å®Œæˆ">
            <button class="complete-course-btn" id="completeCourseBtn" aria-label="å®Œæˆè¯¾ç¨‹å¹¶è¿”å›è¯¾ç¨‹é€‰æ‹©é¡µé¢">
                âœ“ å®Œæˆè¯¾ç¨‹
            </button>
        </div>
    </div>

    <!-- å¼•å…¥AssemblyAIå­—å¹•ç”Ÿæˆå™¨ -->
    <script src="../js/assemblyai-subtitle-generator.js"></script>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
        const state = {
            courseId: null,
            courseData: null,
            userMode: 'hearing', // é»˜è®¤å¬éšœæ¨¡å¼
            currentTask: 1,
            completedTasks: [],
            fontScale: 1
        };
        
        // ==================== URLå‚æ•°è§£æ ====================
        const urlParams = new URLSearchParams(window.location.search);
        state.courseId = urlParams.get('courseId');
        state.userMode = urlParams.get('mode') || localStorage.getItem('userMode') || 'hearing';
        localStorage.setItem('userMode', state.userMode);
        
        // è§†éšœæ¨¡å¼åº”ç”¨å¤§å­—ä½“
        if (state.userMode === 'visual') {
            document.body.classList.add('visual-mode');
            state.fontScale = 1.5;
        } else if (state.userMode === 'hearing') {
            document.body.classList.add('hearing-mode');
        }

        // ==================== ä»»åŠ¡æäº¤æ•°æ®ç®¡ç† ====================
        // è·å–ä»»åŠ¡æäº¤æ•°æ®çš„localStorageé”®å
        function getTaskSubmissionsKey() {
            return 'taskSubmissions';
        }

        // ä¿å­˜ä»»åŠ¡æäº¤å†…å®¹
        function saveTaskSubmission(courseId, taskId, content) {
            const key = getTaskSubmissionsKey();
            const allSubmissions = JSON.parse(localStorage.getItem(key) || '{}');

            if (!allSubmissions[courseId]) {
                allSubmissions[courseId] = {};
            }

            allSubmissions[courseId][taskId] = {
                content: content,
                submittedAt: new Date().toISOString(),
                completed: content.trim().length > 0
            };

            localStorage.setItem(key, JSON.stringify(allSubmissions));
        }

        // åŠ è½½ä»»åŠ¡æäº¤å†…å®¹
        function loadTaskSubmission(courseId, taskId) {
            const key = getTaskSubmissionsKey();
            const allSubmissions = JSON.parse(localStorage.getItem(key) || '{}');

            if (allSubmissions[courseId] && allSubmissions[courseId][taskId]) {
                return allSubmissions[courseId][taskId];
            }

            return null;
        }

        // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
        function isTaskCompleted(courseId, taskId) {
            const submission = loadTaskSubmission(courseId, taskId);
            return submission && submission.completed;
        }

        // æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡æ˜¯å¦å®Œæˆ
        function areAllTasksCompleted(courseId, taskCount) {
            for (let i = 1; i <= taskCount; i++) {
                const taskId = `task${i}`;
                if (!isTaskCompleted(courseId, taskId)) {
                    return false;
                }
            }
            return true;
        }

        // æ›´æ–°å®Œæˆè¯¾ç¨‹æŒ‰é’®çŠ¶æ€
        function updateCompleteCourseButton() {
            const completeCourseBtn = document.getElementById('completeCourseBtn');
            if (!completeCourseBtn || !state.courseData) return;

            const taskCount = state.courseData.tasks ? state.courseData.tasks.length : 0;
            const allCompleted = areAllTasksCompleted(state.courseId, taskCount);

            if (allCompleted) {
                completeCourseBtn.disabled = false;
                completeCourseBtn.setAttribute('aria-disabled', 'false');
                completeCourseBtn.style.opacity = '1';
            } else {
                completeCourseBtn.disabled = true;
                completeCourseBtn.setAttribute('aria-disabled', 'true');
                completeCourseBtn.style.opacity = '0.5';
                completeCourseBtn.title = 'è¯·å®Œæˆæ‰€æœ‰ä»»åŠ¡åå†ç‚¹å‡»å®Œæˆè¯¾ç¨‹';
            }
        }

        // ==================== è¿”å›æŒ‰é’®åŠŸèƒ½ ====================
        const returnBtn = document.getElementById('returnBtn');
        returnBtn.addEventListener('click', () => {
            window.location.href = `course_selection.html?mode=${state.userMode}`;
        });

        // ==================== å®Œæˆè¯¾ç¨‹æŒ‰é’®åŠŸèƒ½ ====================
        const completeCourseBtn = document.getElementById('completeCourseBtn');
        completeCourseBtn.addEventListener('click', async () => {
            if (!state.courseId) {
                showNotification('è¯¾ç¨‹IDæ— æ•ˆ', 'error');
                return;
            }

            try {
                // ä¿å­˜å®ŒæˆçŠ¶æ€åˆ°localStorage
                const completedCourses = JSON.parse(localStorage.getItem('completedCourses') || '[]');
                if (!completedCourses.includes(state.courseId)) {
                    completedCourses.push(state.courseId);
                    localStorage.setItem('completedCourses', JSON.stringify(completedCourses));
                }

                // å‘é€å®Œæˆæ•°æ®åˆ°åç«¯
                const response = await fetch('http://localhost:3000/api/course-completion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        courseId: state.courseId,
                        completedAt: new Date().toISOString(),
                        userMode: state.userMode
                    })
                });

                if (response.ok) {
                    showNotification('è¯¾ç¨‹å·²å®Œæˆï¼', 'success');
                    // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        window.location.href = `course_selection.html?mode=${state.userMode}`;
                    }, 1000);
                } else {
                    // å³ä½¿åç«¯å¤±è´¥ï¼Œä¹Ÿä¿å­˜æœ¬åœ°çŠ¶æ€å¹¶è·³è½¬
                    showNotification('è¯¾ç¨‹å·²å®Œæˆï¼ˆæœ¬åœ°ä¿å­˜ï¼‰', 'success');
                    setTimeout(() => {
                        window.location.href = `course_selection.html?mode=${state.userMode}`;
                    }, 1000);
                }
            } catch (error) {
                console.error('å®Œæˆè¯¾ç¨‹å¤±è´¥:', error);
                // å³ä½¿å‡ºé”™ï¼Œä¹Ÿä¿å­˜æœ¬åœ°çŠ¶æ€å¹¶è·³è½¬
                showNotification('è¯¾ç¨‹å·²å®Œæˆï¼ˆæœ¬åœ°ä¿å­˜ï¼‰', 'success');
                setTimeout(() => {
                    window.location.href = `course_selection.html?mode=${state.userMode}`;
                }, 1000);
            }
        });

        // ==================== åŠ è½½è¯¾ç¨‹æ•°æ® ====================
        async function loadCourseData() {
            if (!state.courseId) {
                showNotification('æœªæŒ‡å®šè¯¾ç¨‹ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:3000/api/courses/${state.courseId}`);
                const result = await response.json();
                
                if (result.success && result.course) {
                    state.courseData = result.course;
                    renderCourseInfo();
                    renderTasks();
                    updateProgress();
                    updateCompleteCourseButton();
                } else {
                    showNotification('åŠ è½½è¯¾ç¨‹å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
                showNotification('åŠ è½½è¯¾ç¨‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡', 'error');
            }
        }
        
        // ==================== æ¸²æŸ“è¯¾ç¨‹ä¿¡æ¯ ====================
        function renderCourseInfo() {
            document.getElementById('courseTitle').textContent = state.courseData.title;
            document.getElementById('courseTitleMain').textContent = state.courseData.title;
            document.getElementById('courseDescription').textContent = state.courseData.description;

            // æ£€æµ‹æ˜¯å¦æœ‰è§†é¢‘
            if (state.courseData.videoUrl && state.courseData.videoUrl.trim() !== '') {
                const videoSection = document.getElementById('videoSection');
                const videoSource = document.getElementById('videoSource');
                const videoPlayer = document.getElementById('videoPlayer');
                const videoSubtitle = document.getElementById('videoSubtitle');

                // è®¾ç½®è§†é¢‘æº
                videoSource.src = state.courseData.videoUrl;

                // è®¾ç½®å­—å¹•æºï¼ˆå¤„ç†CORSé”™è¯¯ï¼‰
                if (state.courseData.subtitleUrl) {
                    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºç»å¯¹è·¯å¾„
                    let subtitleUrl = state.courseData.subtitleUrl;
                    if (!subtitleUrl.startsWith('http://') && !subtitleUrl.startsWith('https://')) {
                        subtitleUrl = `http://localhost:3000/${subtitleUrl}`;
                    }
                    videoSubtitle.src = subtitleUrl;

                    // ç›‘å¬å­—å¹•åŠ è½½é”™è¯¯
                    videoSubtitle.addEventListener('error', function() {
                        console.warn('å­—å¹•åŠ è½½å¤±è´¥ï¼ˆå¯èƒ½æ˜¯CORSé—®é¢˜ï¼‰ï¼š', subtitleUrl);
                        // ä¸æ˜¾ç¤ºé”™è¯¯é€šçŸ¥ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
                    }, { once: true });
                }

                // ç›‘å¬è§†é¢‘åŠ è½½é”™è¯¯
                videoPlayer.addEventListener('error', function() {
                    const error = videoPlayer.error;
                    if (error && error.code === error.MEDIA_ERR_SRC_NOT_SUPPORTED) {
                        showNotification('è§†é¢‘æ ¼å¼ä¸æ”¯æŒæˆ–é“¾æ¥æ— æ•ˆ', 'error');
                    }
                }, { once: true });

                videoPlayer.load();

                // æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨
                videoSection.classList.add('visible');

                // åˆå§‹åŒ–è§†é¢‘æ§åˆ¶
                initVideoControls();
            }
        }

        // ==================== åˆå§‹åŒ–è§†é¢‘æ§åˆ¶ ====================
        function initVideoControls() {
            const videoPlayer = document.getElementById('videoPlayer');
            const showSubtitleBtn = document.getElementById('showSubtitleBtn');
            const hideSubtitleBtn = document.getElementById('hideSubtitleBtn');
            const subtitleSizeSlider = document.getElementById('subtitleSizeSlider');
            const subtitleSizeValue = document.getElementById('subtitleSizeValue');

            // ç­‰å¾…è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåå†åˆå§‹åŒ–å­—å¹•æ§åˆ¶
            const setupSubtitleControls = () => {
                // ==================== å­—å¹•æ§åˆ¶ ====================
                const videoTrack = videoPlayer.textTracks[0];

                // é»˜è®¤æ˜¾ç¤ºå­—å¹•
                if (videoTrack) {
                    videoTrack.mode = 'showing';
                    console.log('å­—å¹•è½¨é“å·²åŠ è½½å¹¶è®¾ç½®ä¸ºæ˜¾ç¤ºæ¨¡å¼');
                } else {
                    console.warn('æœªæ‰¾åˆ°å­—å¹•è½¨é“');
                }

                // å­—å¹•æ§åˆ¶æŒ‰é’®ï¼ˆä»…å¬éšœæ¨¡å¼ï¼‰
                if (state.userMode === 'hearing' && showSubtitleBtn && hideSubtitleBtn && subtitleSizeSlider) {
                    // æ˜¾ç¤ºå­—å¹•æŒ‰é’®
                    showSubtitleBtn.addEventListener('click', () => {
                        const track = videoPlayer.textTracks[0];
                        if (track) {
                            track.mode = 'showing';
                            showSubtitleBtn.classList.add('active');
                            hideSubtitleBtn.classList.remove('active');
                        }
                    });

                    // éšè—å­—å¹•æŒ‰é’®
                    hideSubtitleBtn.addEventListener('click', () => {
                        const track = videoPlayer.textTracks[0];
                        if (track) {
                            track.mode = 'hidden';
                            hideSubtitleBtn.classList.add('active');
                            showSubtitleBtn.classList.remove('active');
                        }
                    });

                // å­—å¹•å¤§å°è°ƒèŠ‚
                subtitleSizeSlider.addEventListener('input', (e) => {
                    const size = parseInt(e.target.value);
                    subtitleSizeValue.textContent = size;

                    // é€šè¿‡CSSå˜é‡æ§åˆ¶å­—å¹•å¤§å°
                    const style = document.createElement('style');
                    style.id = 'subtitle-size-style';
                    const existingStyle = document.getElementById('subtitle-size-style');
                    if (existingStyle) {
                        existingStyle.remove();
                    }
                    style.textContent = `
                        video::cue {
                            font-size: ${size}px !important;
                        }
                    `;
                    document.head.appendChild(style);
                });
            }
            };

            // å¦‚æœè§†é¢‘å·²ç»åŠ è½½äº†å…ƒæ•°æ®ï¼Œç›´æ¥åˆå§‹åŒ–
            if (videoPlayer.readyState >= 1) {
                setupSubtitleControls();
            } else {
                // å¦åˆ™ç­‰å¾…å…ƒæ•°æ®åŠ è½½å®Œæˆ
                videoPlayer.addEventListener('loadedmetadata', setupSubtitleControls, { once: true });
            }

            // ==================== AssemblyAIå­—å¹•ç”Ÿæˆå™¨åˆå§‹åŒ– ====================
            initAssemblyAISubtitleGenerator();
        }

        // ==================== åˆå§‹åŒ–AssemblyAIå­—å¹•ç”Ÿæˆå™¨ ====================
        function initAssemblyAISubtitleGenerator() {
            const generateSubtitleBtn = document.getElementById('generateSubtitleBtn');
            const subtitleStatus = document.getElementById('subtitleStatus');
            const subtitleStatusText = document.getElementById('subtitleStatusText');
            const videoPlayer = document.getElementById('videoPlayer');
            const videoSource = document.getElementById('videoSource');
            const videoIframe = document.getElementById('videoIframe');

            if (!generateSubtitleBtn) return;

            // ä»URLè·å–courseId
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('courseId');

            let isGenerating = false;
            let pollingInterval = null;

            // ç”Ÿæˆå­—å¹•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            generateSubtitleBtn.addEventListener('click', async () => {
                if (!isGenerating) {
                    await startSubtitleGeneration();
                }
            });

            // å¼€å§‹ç”Ÿæˆå­—å¹•
            async function startSubtitleGeneration() {
                try {
                    // è·å–å½“å‰è§†é¢‘URL
                    const videoUrl = getVideoUrl();

                    if (!videoUrl) {
                        showNotification('è¯·å…ˆåŠ è½½è§†é¢‘', 'error');
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ¥è§†é¢‘æ–‡ä»¶
                    if (videoIframe.style.display !== 'none') {
                        showNotification('å­—å¹•ç”Ÿæˆä»…æ”¯æŒç›´æ¥è§†é¢‘æ–‡ä»¶ï¼Œä¸æ”¯æŒBilibili/YouTubeåµŒå…¥è§†é¢‘', 'error');
                        return;
                    }

                    // æ˜¾ç¤ºçŠ¶æ€
                    subtitleStatus.style.display = 'block';
                    subtitleStatus.className = 'subtitle-status active';
                    subtitleStatusText.textContent = 'æ­£åœ¨æäº¤è½¬å½•ä»»åŠ¡...';
                    isGenerating = true;
                    generateSubtitleBtn.disabled = true;

                    // æäº¤è½¬å½•ä»»åŠ¡
                    const submitResponse = await fetch('http://localhost:3000/api/subtitles/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            videoUrl: videoUrl,
                            courseId: courseId,
                            language: 'zh'
                        })
                    });

                    if (!submitResponse.ok) {
                        throw new Error('æäº¤è½¬å½•ä»»åŠ¡å¤±è´¥');
                    }

                    const submitData = await submitResponse.json();
                    const transcriptId = submitData.transcriptId;

                    subtitleStatusText.textContent = 'è½¬å½•ä¸­ï¼Œè¯·ç¨å€™...';
                    showNotification('å­—å¹•ç”Ÿæˆä»»åŠ¡å·²æäº¤', 'success');

                    // è½®è¯¢æ£€æŸ¥è½¬å½•çŠ¶æ€
                    pollingInterval = setInterval(async () => {
                        await checkTranscriptionStatus(transcriptId);
                    }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡

                } catch (error) {
                    console.error('å¯åŠ¨å­—å¹•ç”Ÿæˆå¤±è´¥:', error);
                    subtitleStatus.className = 'subtitle-status error';
                    subtitleStatusText.textContent = 'ç”Ÿæˆå¤±è´¥: ' + error.message;
                    showNotification('å­—å¹•ç”Ÿæˆå¤±è´¥', 'error');
                    resetGenerationState();
                }
            }

            // è·å–è§†é¢‘URL
            function getVideoUrl() {
                // æ£€æŸ¥videoSourceæ˜¯å¦æœ‰æœ‰æ•ˆçš„src
                if (videoSource && videoSource.src && videoSource.src.trim() !== '') {
                    return videoSource.src;
                }
                return null;
            }

            // æ£€æŸ¥è½¬å½•çŠ¶æ€
            async function checkTranscriptionStatus(transcriptId) {
                try {
                    const response = await fetch(`http://localhost:3000/api/subtitles/status/${transcriptId}`);

                    if (!response.ok) {
                        throw new Error('æ£€æŸ¥è½¬å½•çŠ¶æ€å¤±è´¥');
                    }

                    const data = await response.json();

                    if (data.status === 'completed') {
                        // è½¬å½•å®Œæˆï¼Œç”ŸæˆVTTæ–‡ä»¶
                        clearInterval(pollingInterval);
                        await generateVTTFile(transcriptId);
                    } else if (data.status === 'error') {
                        throw new Error('è½¬å½•å¤±è´¥');
                    } else {
                        // ä»åœ¨å¤„ç†ä¸­
                        subtitleStatusText.textContent = `è½¬å½•ä¸­... (${data.status})`;
                    }

                } catch (error) {
                    console.error('æ£€æŸ¥è½¬å½•çŠ¶æ€å¤±è´¥:', error);
                    clearInterval(pollingInterval);
                    subtitleStatus.className = 'subtitle-status error';
                    subtitleStatusText.textContent = 'æ£€æŸ¥çŠ¶æ€å¤±è´¥';
                    showNotification('å­—å¹•ç”Ÿæˆå¤±è´¥', 'error');
                    resetGenerationState();
                }
            }

            // ç”ŸæˆVTTæ–‡ä»¶
            async function generateVTTFile(transcriptId) {
                try {
                    subtitleStatusText.textContent = 'æ­£åœ¨ç”Ÿæˆå­—å¹•æ–‡ä»¶...';

                    const response = await fetch('http://localhost:3000/api/subtitles/to-vtt', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            transcriptId: transcriptId,
                            courseId: courseId
                        })
                    });

                    if (!response.ok) {
                        throw new Error('ç”ŸæˆVTTæ–‡ä»¶å¤±è´¥');
                    }

                    const data = await response.json();

                    // åŠ è½½å­—å¹•åˆ°è§†é¢‘æ’­æ”¾å™¨
                    loadSubtitlesToPlayer(data.filePath);

                    subtitleStatus.className = 'subtitle-status success';
                    subtitleStatusText.textContent = 'å­—å¹•ç”ŸæˆæˆåŠŸï¼';
                    showNotification('å­—å¹•å·²ç”Ÿæˆå¹¶åŠ è½½', 'success');

                    setTimeout(() => {
                        subtitleStatus.style.display = 'none';
                        resetGenerationState();
                    }, 3000);

                } catch (error) {
                    console.error('ç”ŸæˆVTTæ–‡ä»¶å¤±è´¥:', error);
                    subtitleStatus.className = 'subtitle-status error';
                    subtitleStatusText.textContent = 'ç”Ÿæˆå­—å¹•æ–‡ä»¶å¤±è´¥';
                    showNotification('å­—å¹•ç”Ÿæˆå¤±è´¥', 'error');
                    resetGenerationState();
                }
            }

            // åŠ è½½å­—å¹•åˆ°è§†é¢‘æ’­æ”¾å™¨
            function loadSubtitlesToPlayer(vttFilePath) {
                // ç§»é™¤ç°æœ‰å­—å¹•è½¨é“
                const existingTracks = videoPlayer.querySelectorAll('track');
                existingTracks.forEach(track => track.remove());

                // æ·»åŠ æ–°å­—å¹•è½¨é“
                const track = document.createElement('track');
                track.kind = 'subtitles';
                track.label = 'ä¸­æ–‡';
                track.srclang = 'zh';
                track.src = vttFilePath;
                track.default = true;

                videoPlayer.appendChild(track);

                // å¯ç”¨å­—å¹•æ˜¾ç¤º
                if (videoPlayer.textTracks.length > 0) {
                    videoPlayer.textTracks[0].mode = 'showing';
                }
            }

            // é‡ç½®ç”ŸæˆçŠ¶æ€
            function resetGenerationState() {
                isGenerating = false;
                generateSubtitleBtn.disabled = false;
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }
        }

        // ==================== è§†é¢‘é“¾æ¥åŠ è½½åŠŸèƒ½ ====================
        function initVideoLinkLoader() {
            const videoLinkInput = document.getElementById('videoLinkInput');
            const loadVideoLinkBtn = document.getElementById('loadVideoLinkBtn');
            const videoSection = document.getElementById('videoSection');
            const videoSource = document.getElementById('videoSource');
            const videoPlayer = document.getElementById('videoPlayer');
            const videoIframe = document.getElementById('videoIframe');

            if (!videoLinkInput || !loadVideoLinkBtn) return;

            // ä»Bilibilié“¾æ¥ä¸­æå–BVå·
            function extractBilibiliId(url) {
                const bvMatch = url.match(/BV[a-zA-Z0-9]+/);
                return bvMatch ? bvMatch[0] : null;
            }

            // ä»YouTubeé“¾æ¥ä¸­æå–è§†é¢‘ID
            function extractYoutubeId(url) {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/,
                    /youtube\.com\/embed\/([a-zA-Z0-9_-]+)/
                ];
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match) return match[1];
                }
                return null;
            }

            // æ£€æµ‹å¹³å°ç±»å‹å¹¶ç”ŸæˆåµŒå…¥é“¾æ¥
            function getPlatformEmbedUrl(url) {
                // Bilibili
                if (url.includes('bilibili.com') || url.includes('b23.tv')) {
                    const bvid = extractBilibiliId(url);
                    if (bvid) {
                        return {
                            platform: 'bilibili',
                            embedUrl: `https://player.bilibili.com/player.html?bvid=${bvid}&high_quality=1&danmaku=0`
                        };
                    }
                }

                // YouTube
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    const videoId = extractYoutubeId(url);
                    if (videoId) {
                        return {
                            platform: 'youtube',
                            embedUrl: `https://www.youtube.com/embed/${videoId}`
                        };
                    }
                }

                // å¦‚æœä¸æ˜¯å¹³å°é“¾æ¥ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ¥è§†é¢‘æ–‡ä»¶
                const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv', '.m4v'];
                const urlLower = url.toLowerCase();
                if (videoExtensions.some(ext => urlLower.includes(ext))) {
                    return {
                        platform: 'direct',
                        embedUrl: url
                    };
                }

                return null;
            }

            // åŠ è½½è§†é¢‘é“¾æ¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            loadVideoLinkBtn.addEventListener('click', () => {
                const videoUrl = videoLinkInput.value.trim();

                // éªŒè¯è¾“å…¥
                if (!videoUrl) {
                    showNotification('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                    return;
                }

                // ç®€å•çš„URLéªŒè¯
                try {
                    new URL(videoUrl);
                } catch (e) {
                    showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘é“¾æ¥', 'error');
                    return;
                }

                // æ£€æµ‹å¹³å°å¹¶è·å–åµŒå…¥é“¾æ¥
                const platformInfo = getPlatformEmbedUrl(videoUrl);

                if (!platformInfo) {
                    showNotification('ä¸æ”¯æŒçš„è§†é¢‘é“¾æ¥æ ¼å¼', 'error');
                    return;
                }

                // æš‚åœå½“å‰æ’­æ”¾
                if (!videoPlayer.paused) {
                    videoPlayer.pause();
                }

                // æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨åŒºåŸŸ
                videoSection.classList.add('visible');

                // æ ¹æ®å¹³å°ç±»å‹åŠ è½½è§†é¢‘
                if (platformInfo.platform === 'direct') {
                    // ç›´æ¥è§†é¢‘æ–‡ä»¶ï¼Œä½¿ç”¨videoæ ‡ç­¾
                    videoPlayer.style.display = 'block';
                    videoIframe.style.display = 'none';

                    videoSource.src = platformInfo.embedUrl;
                    videoPlayer.load();

                    showNotification('æ­£åœ¨åŠ è½½è§†é¢‘...', 'info');

                    // ç›‘å¬è§†é¢‘åŠ è½½æˆåŠŸ
                    videoPlayer.addEventListener('loadeddata', function onLoaded() {
                        showNotification('è§†é¢‘å·²åŠ è½½æˆåŠŸ', 'success');
                        videoPlayer.removeEventListener('loadeddata', onLoaded);
                    }, { once: true });

                    // ç›‘å¬è§†é¢‘åŠ è½½é”™è¯¯
                    videoPlayer.addEventListener('error', function onError() {
                        const error = videoPlayer.error;
                        let errorMsg = 'è§†é¢‘åŠ è½½å¤±è´¥';

                        if (error) {
                            switch (error.code) {
                                case error.MEDIA_ERR_ABORTED:
                                    errorMsg = 'è§†é¢‘åŠ è½½è¢«ä¸­æ­¢';
                                    break;
                                case error.MEDIA_ERR_NETWORK:
                                    errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è§†é¢‘';
                                    break;
                                case error.MEDIA_ERR_DECODE:
                                    errorMsg = 'è§†é¢‘è§£ç å¤±è´¥ï¼Œå¯èƒ½æ ¼å¼ä¸æ”¯æŒ';
                                    break;
                                case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                                    errorMsg = 'è§†é¢‘æ ¼å¼ä¸æ”¯æŒæˆ–é“¾æ¥æ— æ•ˆ';
                                    break;
                            }
                        }

                        showNotification(errorMsg + 'ã€‚è¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®', 'error');
                        videoPlayer.removeEventListener('error', onError);
                    }, { once: true });

                } else {
                    // å¹³å°è§†é¢‘ï¼Œä½¿ç”¨iframe
                    videoPlayer.style.display = 'none';
                    videoIframe.style.display = 'block';

                    videoIframe.src = platformInfo.embedUrl;

                    const platformName = platformInfo.platform === 'bilibili' ? 'Bilibili' :
                                       platformInfo.platform === 'youtube' ? 'YouTube' : 'å¹³å°';
                    showNotification(`æ­£åœ¨åŠ è½½${platformName}è§†é¢‘...`, 'success');
                }

                // åˆå§‹åŒ–è§†é¢‘æ§åˆ¶ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
                initVideoControls();
            });

            // æ”¯æŒå›è½¦é”®åŠ è½½
            videoLinkInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadVideoLinkBtn.click();
                }
            });
        }

        // ==================== æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ ====================
        function renderTasks() {
            const taskSection = document.getElementById('taskSection');
            taskSection.innerHTML = '';
            taskSection.setAttribute('role', 'list');
            taskSection.setAttribute('aria-label', 'å­¦ä¹ ä»»åŠ¡åˆ—è¡¨');

            if (!state.courseData.tasks || state.courseData.tasks.length === 0) {
                taskSection.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">æš‚æ— ä»»åŠ¡</p>';
                return;
            }

            state.courseData.tasks.forEach((task, index) => {
                const taskCard = createTaskCard(task, index + 1);
                taskSection.appendChild(taskCard);
            });
        }
        
        // ==================== åˆ›å»ºä»»åŠ¡å¡ç‰‡ - çº¿æ€§å¸ƒå±€ ====================
        function createTaskCard(task, taskNumber) {
            const article = document.createElement('article');
            article.className = 'task-card';
            article.id = `task${taskNumber}`;
            article.dataset.taskId = task.taskId;
            article.setAttribute('role', 'listitem');
            article.setAttribute('aria-label', `ä»»åŠ¡${taskNumber}ï¼š${task.taskTitle || 'ä»»åŠ¡' + taskNumber}`);

            // ç¬¬ä¸€ä¸ªä»»åŠ¡é»˜è®¤æ¿€æ´»
            if (taskNumber === 1) {
                article.classList.add('active');
            }

            // ä»»åŠ¡æ ‡é¢˜ï¼ˆä½¿ç”¨h2æ ‡ç­¾ï¼Œæ›´å¥½çš„è¯­ä¹‰ï¼‰
            const title = document.createElement('h2');
            title.className = 'task-title';
            title.innerHTML = `<span aria-hidden="true">${taskNumber}. </span>${task.taskTitle || 'ä»»åŠ¡' + taskNumber}`;

            // ä»»åŠ¡æè¿°
            const description = document.createElement('p');
            description.className = 'task-description';
            description.textContent = task.taskDescription || 'æš‚æ— æè¿°';

            // å¦‚æœæœ‰AIå·¥å…·é“¾æ¥ï¼Œæ˜¾ç¤ºæç¤º
            let aiHint = null;
            if (task.taskParams && task.taskParams.aiPlatform) {
                aiHint = document.createElement('p');
                aiHint.className = 'task-ai-hint';
                aiHint.innerHTML = `<span aria-hidden="true">ğŸ’¡</span> å»ºè®®ä½¿ç”¨ï¼š${task.taskParams.aiPlatform}`;
            }

            // ä»»åŠ¡æ“ä½œæŒ‰é’®ç»„
            const actions = document.createElement('div');
            actions.className = 'task-actions';
            actions.setAttribute('role', 'group');
            actions.setAttribute('aria-label', 'ä»»åŠ¡æ“ä½œ');

            const startBtn = document.createElement('button');
            startBtn.className = 'btn btn-primary';
            startBtn.dataset.action = 'start';
            startBtn.textContent = 'å¼€å§‹ä»»åŠ¡';
            startBtn.setAttribute('aria-label', `å¼€å§‹ä»»åŠ¡${taskNumber}ï¼š${task.taskTitle || 'ä»»åŠ¡' + taskNumber}`);

            // æ£€æŸ¥å‰ä¸€ä¸ªä»»åŠ¡æ˜¯å¦å®Œæˆï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦æœ‰æäº¤å†…å®¹ï¼‰
            const prevTaskId = `task${taskNumber - 1}`;
            const prevTaskCompleted = taskNumber === 1 || isTaskCompleted(state.courseId, prevTaskId);
            if (!prevTaskCompleted) {
                startBtn.disabled = true;
                startBtn.setAttribute('aria-disabled', 'true');
            }

            actions.appendChild(startBtn);

            // ä»»åŠ¡æäº¤åŒºåŸŸ
            const submissionArea = document.createElement('div');
            submissionArea.className = 'task-submission-area';

            const submissionLabel = document.createElement('label');
            submissionLabel.className = 'task-submission-label';
            submissionLabel.textContent = 'ä»»åŠ¡æäº¤ï¼š';
            submissionLabel.setAttribute('for', `submission-${task.taskId}`);

            const submissionTextarea = document.createElement('textarea');
            submissionTextarea.className = 'task-submission-textarea';
            submissionTextarea.id = `submission-${task.taskId}`;
            submissionTextarea.placeholder = 'è¯·åœ¨æ­¤å¤„ç²˜è´´æˆ–è¾“å…¥æ‚¨çš„ä»»åŠ¡å®Œæˆå†…å®¹...';
            submissionTextarea.setAttribute('aria-label', `ä»»åŠ¡${taskNumber}æäº¤å†…å®¹è¾“å…¥æ¡†`);

            const submitBtn = document.createElement('button');
            submitBtn.className = 'task-submit-btn';
            submitBtn.textContent = 'æäº¤ä»»åŠ¡';
            submitBtn.setAttribute('aria-label', `æäº¤ä»»åŠ¡${taskNumber}`);

            const statusDiv = document.createElement('div');
            statusDiv.className = 'task-status pending';
            statusDiv.id = `status-${task.taskId}`;
            statusDiv.textContent = 'æœªå®Œæˆ';
            statusDiv.setAttribute('role', 'status');
            statusDiv.setAttribute('aria-live', 'polite');

            submissionArea.appendChild(submissionLabel);
            submissionArea.appendChild(submissionTextarea);
            submissionArea.appendChild(submitBtn);
            submissionArea.appendChild(statusDiv);

            // ç»„è£…å¡ç‰‡ - çº¿æ€§é¡ºåº
            article.appendChild(title);
            article.appendChild(description);
            if (aiHint) {
                article.appendChild(aiHint);
            }
            article.appendChild(actions);
            article.appendChild(submissionArea);

            // åŠ è½½ä¹‹å‰ä¿å­˜çš„æäº¤å†…å®¹
            const savedSubmission = loadTaskSubmission(state.courseId, task.taskId);
            if (savedSubmission) {
                submissionTextarea.value = savedSubmission.content;
                if (savedSubmission.completed) {
                    statusDiv.className = 'task-status completed';
                    statusDiv.textContent = 'âœ“ å·²å®Œæˆ';
                    article.classList.add('completed');
                }
            }

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            startBtn.addEventListener('click', () => handleTaskStart(taskNumber, task));

            // æäº¤æŒ‰é’®äº‹ä»¶ç›‘å¬
            submitBtn.addEventListener('click', () => {
                const content = submissionTextarea.value.trim();
                if (content.length === 0) {
                    showNotification('è¯·è¾“å…¥ä»»åŠ¡å®Œæˆå†…å®¹', 'error');
                    return;
                }

                // ä¿å­˜æäº¤å†…å®¹
                saveTaskSubmission(state.courseId, task.taskId, content);

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                statusDiv.className = 'task-status completed';
                statusDiv.textContent = 'âœ“ å·²å®Œæˆ';
                article.classList.add('completed');

                // è°ƒç”¨ä»»åŠ¡å®Œæˆå¤„ç†ï¼Œæ¿€æ´»ä¸‹ä¸€ä¸ªä»»åŠ¡
                handleTaskComplete(taskNumber);

                // æ›´æ–°å®Œæˆè¯¾ç¨‹æŒ‰é’®çŠ¶æ€
                updateCompleteCourseButton();

                showNotification(`ä»»åŠ¡${taskNumber}å·²æäº¤`, 'success');
            });

            return article;
        }
        
        // ==================== ä»»åŠ¡äº¤äº’å¤„ç† ====================
        function handleTaskStart(taskNumber, task) {
            showNotification(`ä»»åŠ¡${taskNumber}å·²å¼€å§‹`, 'info');

            // å¦‚æœæœ‰AIå·¥å…·é“¾æ¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰“å¼€
            if (task.taskParams && task.taskParams.aiPlatform) {
                const aiLinks = state.courseData.aiToolLinks || [];
                const aiLink = aiLinks.find(link => link.name === task.taskParams.aiPlatform);
                if (aiLink) {
                    const shouldOpen = confirm(`æ˜¯å¦æ‰“å¼€${task.taskParams.aiPlatform}ï¼Ÿ\n\næç¤ºè¯æ¨¡æ¿ï¼š${task.taskParams.promptTemplate || 'æ— '}`);
                    if (shouldOpen) {
                        window.open(aiLink.url, '_blank');
                    }
                }
            }

            // ä»»åŠ¡éœ€è¦å­¦å‘˜æäº¤å†…å®¹åæ‰èƒ½å®Œæˆï¼Œä¸å†è‡ªåŠ¨å®Œæˆ
        }
        
        function handleTaskComplete(taskNumber) {
            if (!state.completedTasks.includes(taskNumber)) {
                state.completedTasks.push(taskNumber);

                const taskCard = document.getElementById(`task${taskNumber}`);
                taskCard.classList.add('completed');
                taskCard.classList.remove('active');

                updateProgress();
                showNotification(`ä»»åŠ¡${taskNumber}å·²å®Œæˆï¼`, 'success');

                // æ¿€æ´»ä¸‹ä¸€ä¸ªä»»åŠ¡
                const totalTasks = state.courseData.tasks.length;
                if (taskNumber < totalTasks) {
                    activateNextTask(taskNumber + 1);
                } else {
                    const finalMessage = 'æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰å­¦ä¹ ä»»åŠ¡ï¼';
                    showNotification(finalMessage, 'success');
                }
            }
        }
        
        function activateNextTask(taskNumber) {
            state.currentTask = taskNumber;
            const taskCard = document.getElementById(`task${taskNumber}`);
            taskCard.classList.add('active');
            
            const startBtn = taskCard.querySelector('[data-action="start"]');
            if (startBtn) {
                startBtn.disabled = false;
            }
            
            taskCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ==================== è¿›åº¦æ›´æ–° ====================
        function updateProgress() {
            const totalTasks = state.courseData.tasks.length;
            const completed = state.completedTasks.length;
            const percentage = totalTasks > 0 ? Math.round((completed / totalTasks) * 100) : 0;
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
            progressBar.parentElement.setAttribute('aria-valuenow', percentage);
            
            progressText.textContent = `å·²å®Œæˆ ${completed}/${totalTasks} ä¸ªä»»åŠ¡`;
        }

        // ==================== é€šçŸ¥ç³»ç»Ÿ ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'assertive');
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½è¯¾ç¨‹æ•°æ®
            loadCourseData();

            // åˆå§‹åŒ–è§†é¢‘é“¾æ¥åŠ è½½åŠŸèƒ½
            initVideoLinkLoader();

            // æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨åŒºåŸŸï¼ˆå³ä½¿æ²¡æœ‰é¢„è®¾è§†é¢‘ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é“¾æ¥åŠ è½½ï¼‰
            const videoSection = document.getElementById('videoSection');
            if (videoSection) {
                videoSection.classList.add('visible');
            }

            // é”®ç›˜å¯¼èˆªæ”¯æŒ
            document.addEventListener('keydown', (e) => {
                // Escape - è¿”å›
                if (e.key === 'Escape') {
                    returnBtn.click();
                }
            });

            // åˆå§‹åŒ–è¿›åº¦è·Ÿè¸ª
            initProgressTracking();

        });

        // ==================== å­¦ç”Ÿè¿›åº¦è·Ÿè¸ª ====================
        function initProgressTracking() {
            // è·å–å­¦ç”ŸIDï¼ˆå¯ä»¥ä»URLå‚æ•°è·å–ï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId') || 'student_001';
            const courseId = urlParams.get('courseId');

            if (!courseId) return;

            // ç›‘å¬ä»»åŠ¡å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            document.addEventListener('click', async (e) => {
                const taskCard = e.target.closest('.task-card');
                if (taskCard) {
                    const taskNumber = parseInt(taskCard.id.replace('task', ''));
                    const taskIndex = taskNumber - 1;

                    // æ›´æ–°è¿›åº¦
                    await updateStudentProgress(studentId, courseId, taskIndex, 'visit');
                }
            });

            // ç›‘å¬ä»»åŠ¡æäº¤æŒ‰é’®
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('task-submit-btn')) {
                    const taskCard = e.target.closest('.task-card');
                    if (taskCard) {
                        const taskNumber = parseInt(taskCard.id.replace('task', ''));
                        const taskIndex = taskNumber - 1;

                        // æ ‡è®°ä»»åŠ¡å®Œæˆ
                        await updateStudentProgress(studentId, courseId, taskIndex, 'complete');
                    }
                }
            });
        }

        // æ›´æ–°å­¦ç”Ÿè¿›åº¦
        async function updateStudentProgress(studentId, courseId, taskIndex, action) {
            try {
                const response = await fetch('http://localhost:3000/api/progress/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        studentId: studentId,
                        courseId: courseId,
                        taskIndex: taskIndex,
                        action: action
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log('è¿›åº¦å·²æ›´æ–°:', data.progress);
                }
            } catch (error) {
                console.error('æ›´æ–°è¿›åº¦å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>
