<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆç®¡ç†åå° - æ— éšœç¢AIå­¦ä¹ å¹³å°</title>
    
    <style>
        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #212121;
            --text-secondary: #666666;
            --accent-color: #1a73e8;
            --success-color: #34a853;
            --warning-color: #fbbc04;
            --error-color: #ea4335;
            --border-color: #e0e0e0;
            
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
                         "Microsoft YaHei", sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            min-height: 100vh;
        }
        
        /* ==================== é¡¶éƒ¨å¯¼èˆªæ  ==================== */
        .top-nav {
            background-color: var(--accent-color);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-title {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        .nav-btn {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background-color: rgba(255,255,255,0.3);
        }
        
        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl) var(--spacing-md);
        }
        
        .page-header {
            margin-bottom: var(--spacing-xl);
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
        }
        
        .page-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        /* ==================== æ ‡ç­¾é¡µå¯¼èˆª ==================== */
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            color: var(--accent-color);
        }
        
        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ==================== è¡¨å•æ ·å¼ ==================== */
        .form-card {
            background-color: var(--bg-primary);
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: var(--spacing-lg);
        }
        
        .form-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: var(--spacing-sm);
            font-size: 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }
        
        /* ==================== æŒ‰é’®æ ·å¼ ==================== */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 40px;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1557b0;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2d8e47;
        }
        
        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        /* ==================== æ–‡ä»¶ä¸Šä¼ æ ·å¼ ==================== */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: var(--spacing-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-upload-area:hover {
            border-color: var(--accent-color);
            background-color: rgba(26, 115, 232, 0.05);
        }
        
        .file-upload-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-sm);
        }
        
        .file-upload-text {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .file-input {
            display: none;
        }
        
        .file-preview {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
        }

        /* ==================== ä»»åŠ¡ç®¡ç†æ ·å¼ ==================== */
        .tasks-list {
            margin-bottom: var(--spacing-md);
        }

        .task-item {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .task-number {
            font-weight: 600;
            color: var(--accent-color);
        }

        .task-remove-btn {
            background-color: var(--error-color);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .task-remove-btn:hover {
            opacity: 0.8;
        }

        /* ==================== åˆ—è¡¨æ ·å¼ ==================== */
        .item-list {
            list-style: none;
        }
        
        .item-card {
            background-color: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }
        
        .item-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .item-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .item-content {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        
        .item-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="top-nav">
        <div class="nav-left">
            <button class="nav-btn" id="returnBtn">
                â† è¿”å›
            </button>
            <div class="nav-title">ğŸ“š æ•™å¸ˆç®¡ç†åå°</div>
        </div>
        <div class="nav-actions">
            <button class="nav-btn" onclick="window.location.href='qianduan.html'">
                è¿”å›é¦–é¡µ
            </button>
        </div>
    </nav>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <header class="page-header">
            <h1 class="page-title">è¯¾ç¨‹ä¸ä½œä¸šç®¡ç†</h1>
            <p class="page-subtitle">åˆ›å»ºè¯¾ç¨‹ã€å¸ƒç½®ä½œä¸šã€ç®¡ç†å­¦ä¹ å†…å®¹</p>
        </header>
        
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="courses">è¯¾ç¨‹ç®¡ç†</button>
            <button class="tab-btn" data-tab="homework">ä½œä¸šç®¡ç†</button>
            <button class="tab-btn" data-tab="progress">å­¦ç”Ÿè¿›åº¦ç›‘æ§</button>
        </div>
        
        <!-- è¯¾ç¨‹ç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="courses-tab">
            <!-- åˆ›å»ºè¯¾ç¨‹è¡¨å• -->
            <div class="form-card">
                <h2 class="form-title">â• åˆ›å»ºæ–°è¯¾ç¨‹</h2>
                <form id="courseForm">
                    <div class="form-group">
                        <label class="form-label" for="courseTitle">è¯¾ç¨‹æ ‡é¢˜ *</label>
                        <input type="text" id="courseTitle" class="form-input" 
                               placeholder="ä¾‹å¦‚ï¼šAIå›¾åƒç”Ÿæˆå…¥é—¨" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="courseDescription">è¯¾ç¨‹æè¿° *</label>
                        <textarea id="courseDescription" class="form-textarea" 
                                  placeholder="ç®€è¦æè¿°è¯¾ç¨‹å†…å®¹å’Œå­¦ä¹ ç›®æ ‡..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="courseContent">è¯¾ç¨‹æ–‡å­—å†…å®¹</label>
                        <textarea id="courseContent" class="form-textarea" 
                                  placeholder="è¾“å…¥è¯¾ç¨‹çš„è¯¦ç»†æ–‡å­—å†…å®¹..."></textarea>
                        <p class="form-hint">å¯ä»¥åŒ…å«å­¦ä¹ æ­¥éª¤ã€çŸ¥è¯†ç‚¹è®²è§£ç­‰</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="courseVideo">è¯¾ç¨‹è§†é¢‘</label>
                        <div class="file-upload-area" onclick="document.getElementById('courseVideoInput').click()">
                            <div class="file-upload-icon">ğŸ¥</div>
                            <div class="file-upload-text">ç‚¹å‡»ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒMP4ã€AVIç­‰æ ¼å¼ï¼‰</div>
                        </div>
                        <input type="file" id="courseVideoInput" class="file-input" 
                               accept="video/*" onchange="handleVideoUpload(this, 'courseVideoPreview')">
                        <div id="courseVideoPreview" class="file-preview" style="display:none;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="courseAILink">AIå®è·µé“¾æ¥</label>
                        <input type="url" id="courseAILink" class="form-input"
                               placeholder="ä¾‹å¦‚ï¼šhttps://chat.openai.com">
                        <p class="form-hint">å­¦ç”Ÿå¯ä»¥é€šè¿‡æ­¤é“¾æ¥è·³è½¬åˆ°AIå·¥å…·è¿›è¡Œå®è·µ</p>
                    </div>

                    <!-- ä»»åŠ¡ç®¡ç†éƒ¨åˆ† -->
                    <div class="form-group">
                        <label class="form-label">è¯¾ç¨‹ä»»åŠ¡</label>
                        <p class="form-hint">ä¸ºå­¦ç”Ÿæ·»åŠ å…·ä½“çš„å­¦ä¹ ä»»åŠ¡ï¼Œä¾‹å¦‚"ç»™DeepSeekå‘é€ä¸€æ®µè‡ªæˆ‘ä»‹ç»"</p>

                        <div id="tasksList" class="tasks-list">
                            <!-- ä»»åŠ¡åˆ—è¡¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        </div>

                        <button type="button" class="btn btn-secondary" id="addTaskBtn">
                            â• æ·»åŠ ä»»åŠ¡
                        </button>
                    </div>

                    <button type="submit" class="btn btn-primary">åˆ›å»ºè¯¾ç¨‹</button>
                </form>
            </div>
        </div>
        
        <!-- ä½œä¸šç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="homework-tab">
            <!-- å¸ƒç½®ä½œä¸šè¡¨å• -->
            <div class="form-card">
                <h2 class="form-title">ğŸ“ å¸ƒç½®æ–°ä½œä¸š</h2>
                <form id="homeworkForm">
                    <div class="form-group">
                        <label class="form-label" for="homeworkTitle">ä½œä¸šæ ‡é¢˜ *</label>
                        <input type="text" id="homeworkTitle" class="form-input" 
                               placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨AIç”Ÿæˆä¸€å¼ é£æ™¯å›¾ç‰‡" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="homeworkDescription">ä½œä¸šè¦æ±‚ *</label>
                        <textarea id="homeworkDescription" class="form-textarea" 
                                  placeholder="è¯¦ç»†æè¿°ä½œä¸šè¦æ±‚ã€æäº¤æ ¼å¼ã€è¯„åˆ†æ ‡å‡†ç­‰..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="homeworkAILink">AIå·¥å…·é“¾æ¥</label>
                        <input type="url" id="homeworkAILink" class="form-input" 
                               placeholder="ä¾‹å¦‚ï¼šhttps://www.midjourney.com">
                        <p class="form-hint">å­¦ç”Ÿå¯ä»¥ä½¿ç”¨æ­¤AIå·¥å…·å®Œæˆä½œä¸š</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="homeworkDeadline">æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" id="homeworkDeadline" class="form-input">
                    </div>
                    
                    <button type="submit" class="btn btn-success">å¸ƒç½®ä½œä¸š</button>
                </form>
            </div>
        </div>

        <!-- å­¦ç”Ÿè¿›åº¦ç›‘æ§æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="progress-tab">
            <div class="form-card">
                <h2 class="form-title">ğŸ“Š å­¦ç”Ÿè¿›åº¦ç›‘æ§</h2>
                <p class="form-hint">å®æ—¶æŸ¥çœ‹å­¦ç”Ÿå­¦ä¹ è¿›åº¦ï¼ŒåŠæ—¶å‘ç°éœ€è¦å¸®åŠ©çš„å­¦ç”Ÿ</p>

                <!-- åˆ·æ–°æŒ‰é’® -->
                <button class="btn btn-primary" id="refreshProgressBtn" style="margin-bottom: 20px;">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>

                <!-- å¡ä½çš„å­¦ç”Ÿè­¦æŠ¥ -->
                <div id="stuckStudentsSection" style="margin-bottom: 30px;">
                    <h3 style="color: var(--error-color); margin-bottom: 15px;">âš ï¸ éœ€è¦å¸®åŠ©çš„å­¦ç”Ÿ</h3>
                    <div id="stuckStudentsList"></div>
                </div>

                <!-- æ‰€æœ‰å­¦ç”Ÿè¿›åº¦ -->
                <div id="allProgressSection">
                    <h3 style="margin-bottom: 15px;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿè¿›åº¦</h3>
                    <div id="allProgressList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== URLå‚æ•°å¤„ç† ====================
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');
        const courseId = urlParams.get('courseId');

        // æ ¹æ®actionå‚æ•°åˆ‡æ¢åˆ°ç›¸åº”çš„æ ‡ç­¾é¡µ
        if (action === 'homework') {
            // åˆ‡æ¢åˆ°ä½œä¸šç®¡ç†æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="homework"]').classList.add('active');
            document.getElementById('homework-tab').classList.add('active');
        } else if (action === 'edit' && courseId) {
            // ç¼–è¾‘è¯¾ç¨‹æ¨¡å¼ - ä¿æŒåœ¨è¯¾ç¨‹ç®¡ç†æ ‡ç­¾é¡µ
            // è¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½è¯¾ç¨‹æ•°æ®çš„é€»è¾‘
            console.log('ç¼–è¾‘è¯¾ç¨‹ID:', courseId);
        }
        // action === 'create' æˆ–é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¾ç¤ºè¯¾ç¨‹ç®¡ç†æ ‡ç­¾é¡µï¼ˆé»˜è®¤å·²æ¿€æ´»ï¼‰

        // ==================== ä»»åŠ¡ç®¡ç† ====================
        let courseTasks = []; // å­˜å‚¨è¯¾ç¨‹ä»»åŠ¡åˆ—è¡¨

        // æ·»åŠ ä»»åŠ¡æŒ‰é’®äº‹ä»¶
        document.getElementById('addTaskBtn').addEventListener('click', () => {
            addNewTask();
        });

        // æ·»åŠ æ–°ä»»åŠ¡
        function addNewTask() {
            const taskId = `task_${Date.now()}`;
            const task = {
                taskId: taskId,
                taskType: 'ai_chat',
                taskTitle: '',
                taskDescription: '',
                taskParams: {
                    aiPlatform: 'DeepSeek',
                    promptTemplate: '',
                    expectedLength: ''
                },
                order: courseTasks.length + 1
            };

            courseTasks.push(task);
            renderTasks();
        }

        // åˆ é™¤ä»»åŠ¡
        function removeTask(taskId) {
            courseTasks = courseTasks.filter(t => t.taskId !== taskId);
            // é‡æ–°æ’åº
            courseTasks.forEach((task, index) => {
                task.order = index + 1;
            });
            renderTasks();
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';

            courseTasks.forEach((task, index) => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-header">
                        <span class="task-number">ä»»åŠ¡ ${index + 1}</span>
                        <button type="button" class="task-remove-btn" onclick="removeTask('${task.taskId}')">åˆ é™¤</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä»»åŠ¡æ ‡é¢˜</label>
                        <input type="text" class="form-input" value="${task.taskTitle}"
                               onchange="updateTaskField('${task.taskId}', 'taskTitle', this.value)"
                               placeholder="ä¾‹å¦‚ï¼šä¸AIè¿›è¡Œè‡ªæˆ‘ä»‹ç»">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä»»åŠ¡æè¿°</label>
                        <textarea class="form-textarea"
                                  onchange="updateTaskField('${task.taskId}', 'taskDescription', this.value)"
                                  placeholder="è¯¦ç»†æè¿°å­¦ç”Ÿéœ€è¦å®Œæˆçš„ä»»åŠ¡...">${task.taskDescription}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">AIå¹³å°</label>
                        <select class="form-input" onchange="updateTaskParam('${task.taskId}', 'aiPlatform', this.value)">
                            <option value="DeepSeek" ${task.taskParams.aiPlatform === 'DeepSeek' ? 'selected' : ''}>DeepSeek</option>
                            <option value="ChatGPT" ${task.taskParams.aiPlatform === 'ChatGPT' ? 'selected' : ''}>ChatGPT</option>
                            <option value="Claude" ${task.taskParams.aiPlatform === 'Claude' ? 'selected' : ''}>Claude</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æç¤ºè¯æ¨¡æ¿</label>
                        <input type="text" class="form-input" value="${task.taskParams.promptTemplate}"
                               onchange="updateTaskParam('${task.taskId}', 'promptTemplate', this.value)"
                               placeholder="ä¾‹å¦‚ï¼šä½ å¥½ï¼Œæˆ‘æ˜¯[ä½ çš„åå­—]...">
                    </div>
                `;
                tasksList.appendChild(taskItem);
            });
        }

        // æ›´æ–°ä»»åŠ¡å­—æ®µ
        function updateTaskField(taskId, field, value) {
            const task = courseTasks.find(t => t.taskId === taskId);
            if (task) {
                task[field] = value;
            }
        }

        // æ›´æ–°ä»»åŠ¡å‚æ•°
        function updateTaskParam(taskId, param, value) {
            const task = courseTasks.find(t => t.taskId === taskId);
            if (task) {
                task.taskParams[param] = value;
            }
        }

        // ==================== è¿”å›æŒ‰é’® ====================
        const returnBtn = document.getElementById('returnBtn');
        if (returnBtn) {
            returnBtn.addEventListener('click', () => {
                window.location.href = 'course_selection.html?mode=teacher';
            });
        }

        // ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                btn.classList.add('active');
                const tabId = btn.dataset.tab + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // ==================== æ–‡ä»¶ä¸Šä¼ å¤„ç† ====================
        function handleVideoUpload(input, previewId) {
            const file = input.files[0];
            const preview = document.getElementById(previewId);
            
            if (file) {
                preview.style.display = 'block';
                preview.innerHTML = `
                    <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong> ${file.name} 
                    <br><strong>æ–‡ä»¶å¤§å°ï¼š</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
                `;
            } else {
                preview.style.display = 'none';
            }
        }
        
        // ==================== è¯¾ç¨‹è¡¨å•æäº¤ ====================
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const courseData = {
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                content: document.getElementById('courseContent').value,
                videoUrl: document.getElementById('courseVideoInput').files[0]?.name || '',
                aiToolLinks: [],
                tasks: courseTasks, // åŒ…å«ä»»åŠ¡æ•°æ®
                createdBy: 'teacher_001'
            };

            // å¦‚æœæœ‰AIé“¾æ¥ï¼Œæ·»åŠ åˆ°aiToolLinksæ•°ç»„
            const aiLink = document.getElementById('courseAILink').value;
            if (aiLink) {
                courseData.aiToolLinks.push({
                    name: 'AIå·¥å…·',
                    url: aiLink
                });
            }

            try {
                // å‘é€åˆ°åç«¯API
                const response = await fetch('http://localhost:3000/api/courses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('è¯¾ç¨‹åˆ›å»ºæˆåŠŸï¼\n\nè¯¾ç¨‹æ ‡é¢˜ï¼š' + courseData.title + '\nä»»åŠ¡æ•°é‡ï¼š' + courseTasks.length);

                    // é‡ç½®è¡¨å•å’Œä»»åŠ¡åˆ—è¡¨
                    e.target.reset();
                    document.getElementById('courseVideoPreview').style.display = 'none';
                    courseTasks = [];
                    renderTasks();
                } else {
                    alert('è¯¾ç¨‹åˆ›å»ºå¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ›å»ºè¯¾ç¨‹æ—¶å‡ºé”™:', error);
                alert('åˆ›å»ºè¯¾ç¨‹å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨å·²å¯åŠ¨ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
            }
        });
        
        // ==================== ä½œä¸šè¡¨å•æäº¤ ====================
        document.getElementById('homeworkForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const homeworkData = {
                title: document.getElementById('homeworkTitle').value,
                description: document.getElementById('homeworkDescription').value,
                aiLink: document.getElementById('homeworkAILink').value,
                deadline: document.getElementById('homeworkDeadline').value,
                createdAt: new Date().toISOString()
            };
            
            // è¿™é‡Œæš‚æ—¶åªæ˜¯æ˜¾ç¤ºæç¤ºï¼Œå®é™…åº”è¯¥å‘é€åˆ°åç«¯
            alert('ä½œä¸šå¸ƒç½®æˆåŠŸï¼\n\nä½œä¸šæ ‡é¢˜ï¼š' + homeworkData.title + '\n\næ³¨æ„ï¼šå½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼ï¼Œæ•°æ®æœªä¿å­˜åˆ°æœåŠ¡å™¨ã€‚');
            
            // é‡ç½®è¡¨å•
            e.target.reset();
        });

        // ==================== å­¦ç”Ÿè¿›åº¦ç›‘æ§ ====================
        // è·å–æ‰€æœ‰å­¦ç”Ÿè¿›åº¦
        async function loadAllProgress() {
            try {
                const response = await fetch('http://localhost:3000/api/progress/all');
                const data = await response.json();

                if (data.success) {
                    displayAllProgress(data.progress);
                }
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿè¿›åº¦å¤±è´¥:', error);
            }
        }

        // è·å–å¡ä½çš„å­¦ç”Ÿ
        async function loadStuckStudents() {
            try {
                const response = await fetch('http://localhost:3000/api/progress/stuck');
                const data = await response.json();

                if (data.success) {
                    displayStuckStudents(data.stuckStudents);
                }
            } catch (error) {
                console.error('è·å–å¡ä½å­¦ç”Ÿå¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå¡ä½çš„å­¦ç”Ÿ
        function displayStuckStudents(stuckStudents) {
            const container = document.getElementById('stuckStudentsList');

            if (stuckStudents.length === 0) {
                container.innerHTML = '<p style="color: var(--success-color);">âœ… ç›®å‰æ²¡æœ‰å­¦ç”Ÿéœ€è¦å¸®åŠ©</p>';
                return;
            }

            let html = '<ul class="item-list">';
            stuckStudents.forEach(progress => {
                const stuckTime = calculateTimeDiff(progress.lastActivity);
                html += `
                    <li class="item-card" style="border-left: 4px solid var(--error-color);">
                        <div class="item-header">
                            <div>
                                <span class="item-title">å­¦ç”ŸID: ${progress.studentId}</span>
                                <span style="color: var(--text-secondary); margin-left: 10px;">è¯¾ç¨‹: ${progress.courseId}</span>
                            </div>
                        </div>
                        <div class="item-content">
                            <strong>å¡åœ¨ä»»åŠ¡ ${progress.taskIndex + 1}</strong> - å·²åœç•™ ${stuckTime}
                        </div>
                        <div class="item-meta">
                            è®¿é—®æ¬¡æ•°: ${progress.visitCount || 1} æ¬¡ | æœ€åæ´»åŠ¨: ${formatDateTime(progress.lastActivity)}
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿè¿›åº¦
        function displayAllProgress(progressList) {
            const container = document.getElementById('allProgressList');

            if (progressList.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— å­¦ç”Ÿè¿›åº¦æ•°æ®</p>';
                return;
            }

            let html = '<ul class="item-list">';
            progressList.forEach(progress => {
                const statusColor = progress.completed ? 'var(--success-color)' : 'var(--warning-color)';
                const statusText = progress.completed ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­';
                const timeDiff = calculateTimeDiff(progress.lastActivity);

                html += `
                    <li class="item-card">
                        <div class="item-header">
                            <div>
                                <span class="item-title">å­¦ç”ŸID: ${progress.studentId}</span>
                                <span style="color: ${statusColor}; margin-left: 10px;">${statusText}</span>
                            </div>
                        </div>
                        <div class="item-content">
                            è¯¾ç¨‹: ${progress.courseId} | ä»»åŠ¡ ${progress.taskIndex + 1}
                        </div>
                        <div class="item-meta">
                            å¼€å§‹æ—¶é—´: ${formatDateTime(progress.startTime)} |
                            æœ€åæ´»åŠ¨: ${formatDateTime(progress.lastActivity)} (${timeDiff}å‰) |
                            è®¿é—®æ¬¡æ•°: ${progress.visitCount || 1} æ¬¡
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // è®¡ç®—æ—¶é—´å·®
        function calculateTimeDiff(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿ`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}å°æ—¶`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}å¤©`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // åˆ·æ–°è¿›åº¦æ•°æ®
        document.getElementById('refreshProgressBtn').addEventListener('click', async () => {
            await loadStuckStudents();
            await loadAllProgress();
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢æ—¶åŠ è½½æ•°æ®
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (btn.dataset.tab === 'progress') {
                    await loadStuckStudents();
                    await loadAllProgress();
                }
            });
        });
    </script>
</body>
</html>
