<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆç®¡ç†åå° - æ— éšœç¢AIå­¦ä¹ å¹³å°</title>
    
    <style>
        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #212121;
            --text-secondary: #666666;
            --accent-color: #1a73e8;
            --success-color: #34a853;
            --warning-color: #fbbc04;
            --error-color: #ea4335;
            --border-color: #e0e0e0;
            
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
                         "Microsoft YaHei", sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            min-height: 100vh;
        }
        
        /* ==================== é¡¶éƒ¨å¯¼èˆªæ  ==================== */
        .top-nav {
            background-color: var(--accent-color);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-title {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        .nav-btn {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background-color: rgba(255,255,255,0.3);
        }
        
        /* ==================== ä¸»å®¹å™¨ ==================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl) var(--spacing-md);
        }
        
        .page-header {
            margin-bottom: var(--spacing-xl);
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
        }
        
        .page-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        /* ==================== æ ‡ç­¾é¡µå¯¼èˆª ==================== */
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            color: var(--accent-color);
        }
        
        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ==================== è¡¨å•æ ·å¼ ==================== */
        .form-card {
            background-color: var(--bg-primary);
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: var(--spacing-lg);
        }
        
        .form-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: var(--spacing-sm);
            font-size: 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }
        
        /* ==================== æŒ‰é’®æ ·å¼ ==================== */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 40px;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1557b0;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2d8e47;
        }
        
        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        /* ==================== æ–‡ä»¶ä¸Šä¼ æ ·å¼ ==================== */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: var(--spacing-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-upload-area:hover {
            border-color: var(--accent-color);
            background-color: rgba(26, 115, 232, 0.05);
        }
        
        .file-upload-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-sm);
        }
        
        .file-upload-text {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .file-input {
            display: none;
        }
        
        .file-preview {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
        }

        /* ==================== ä»»åŠ¡ç®¡ç†æ ·å¼ ==================== */
        .tasks-list {
            margin-bottom: var(--spacing-md);
        }

        .task-item {
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .task-number {
            font-weight: 600;
            color: var(--accent-color);
        }

        .task-remove-btn {
            background-color: var(--error-color);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .task-remove-btn:hover {
            opacity: 0.8;
        }

        /* ==================== åˆ—è¡¨æ ·å¼ ==================== */
        .item-list {
            list-style: none;
        }
        
        .item-card {
            background-color: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }
        
        .item-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .item-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .item-content {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        
        .item-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="top-nav">
        <div class="nav-left">
            <button class="nav-btn" id="returnBtn">
                â† è¿”å›
            </button>
            <div class="nav-title">ğŸ“š æ•™å¸ˆç®¡ç†åå°</div>
        </div>
        <div class="nav-actions">
            <button class="nav-btn" onclick="window.location.href='qianduan.html'">
                è¿”å›é¦–é¡µ
            </button>
        </div>
    </nav>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <header class="page-header">
            <h1 class="page-title">è¯¾ç¨‹ä¸ä½œä¸šç®¡ç†</h1>
            <p class="page-subtitle">åˆ›å»ºè¯¾ç¨‹ã€å¸ƒç½®ä½œä¸šã€ç®¡ç†å­¦ä¹ å†…å®¹</p>
        </header>
        
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="courses">è¯¾ç¨‹ç®¡ç†</button>
            <button class="tab-btn" data-tab="homework">ä½œä¸šç®¡ç†</button>
            <button class="tab-btn" data-tab="homework-monitor">ä½œä¸šç›‘æ§</button>
            <button class="tab-btn" data-tab="progress">å­¦ç”Ÿè¿›åº¦ç›‘æ§</button>
        </div>
        
        <!-- è¯¾ç¨‹ç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="courses-tab">
            <!-- ç°æœ‰è¯¾ç¨‹åˆ—è¡¨ -->
            <div class="form-card">
                <h2 class="form-title">ğŸ“š ç°æœ‰è¯¾ç¨‹</h2>
                <div id="existingCoursesList">
                    <p style="color: var(--text-secondary); text-align: center;">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <!-- åˆ›å»ºæ–°è¯¾ç¨‹æŒ‰é’® -->
            <div class="form-card" style="text-align: center; padding: var(--spacing-lg);">
                <button class="btn btn-success" id="createNewCourseBtn" style="font-size: 18px; padding: var(--spacing-md) var(--spacing-xl);">
                    â• åˆ›å»ºæ–°è¯¾ç¨‹
                </button>
                <p class="form-hint" style="margin-top: var(--spacing-sm);">ç‚¹å‡»æŒ‰é’®åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç™½è¯¾ç¨‹ï¼Œç„¶ååœ¨ä¸‹æ–¹ç¼–è¾‘è¯¾ç¨‹å†…å®¹</p>
            </div>

            <!-- ç¼–è¾‘è¯¾ç¨‹è¡¨å• -->
            <div class="form-card">
                <h2 class="form-title" id="courseFormTitle">âœï¸ ç¼–è¾‘è¯¾ç¨‹</h2>
                <p class="form-hint" style="margin-bottom: var(--spacing-lg);" id="courseFormHint">è¯·å…ˆç‚¹å‡»ä¸Šæ–¹"åˆ›å»ºæ–°è¯¾ç¨‹"æŒ‰é’®ï¼Œæˆ–ä»è¯¾ç¨‹åˆ—è¡¨ä¸­é€‰æ‹©è¦ç¼–è¾‘çš„è¯¾ç¨‹</p>
                <form id="courseForm">
                    <div class="form-group">
                        <label class="form-label" for="courseTitle">è¯¾ç¨‹æ ‡é¢˜ *</label>
                        <input type="text" id="courseTitle" class="form-input" 
                               placeholder="ä¾‹å¦‚ï¼šAIå›¾åƒç”Ÿæˆå…¥é—¨" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="courseDescription">è¯¾ç¨‹æè¿° *</label>
                        <textarea id="courseDescription" class="form-textarea" 
                                  placeholder="ç®€è¦æè¿°è¯¾ç¨‹å†…å®¹å’Œå­¦ä¹ ç›®æ ‡..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="courseContent">è¯¾ç¨‹æ–‡å­—å†…å®¹</label>
                        <textarea id="courseContent" class="form-textarea" 
                                  placeholder="è¾“å…¥è¯¾ç¨‹çš„è¯¦ç»†æ–‡å­—å†…å®¹..."></textarea>
                        <p class="form-hint">å¯ä»¥åŒ…å«å­¦ä¹ æ­¥éª¤ã€çŸ¥è¯†ç‚¹è®²è§£ç­‰</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è¯¾ç¨‹è§†é¢‘æ–‡ä»¶</label>
                        <div class="file-upload-area" id="videoUploadArea">
                            <div class="file-upload-icon">ğŸ¬</div>
                            <div class="file-upload-text">
                                ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ è§†é¢‘æ–‡ä»¶<br>
                                <small>æ”¯æŒ MP4, WebM, OGG ç­‰æ ¼å¼</small>
                            </div>
                        </div>
                        <input type="file" id="courseVideoFile" class="file-input" accept="video/*">
                        <div id="videoFilePreview" class="file-preview" style="display: none;">
                            <strong>å·²é€‰æ‹©ï¼š</strong><span id="videoFileName"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è§†é¢‘å­—å¹•æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                        <div class="file-upload-area" id="subtitleUploadArea">
                            <div class="file-upload-icon">ğŸ“</div>
                            <div class="file-upload-text">
                                ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å­—å¹•æ–‡ä»¶<br>
                                <small>æ”¯æŒ VTT, SRT æ ¼å¼</small>
                            </div>
                        </div>
                        <input type="file" id="courseSubtitleFile" class="file-input" accept=".vtt,.srt">
                        <div id="subtitleFilePreview" class="file-preview" style="display: none;">
                            <strong>å·²é€‰æ‹©ï¼š</strong><span id="subtitleFileName"></span>
                        </div>
                        <p class="form-hint">å¦‚æœä¸ä¸Šä¼ å­—å¹•æ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆå­—å¹•</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="courseAILink">AIå®è·µé“¾æ¥</label>
                        <input type="url" id="courseAILink" class="form-input"
                               placeholder="ä¾‹å¦‚ï¼šhttps://chat.openai.com">
                        <p class="form-hint">å­¦ç”Ÿå¯ä»¥é€šè¿‡æ­¤é“¾æ¥è·³è½¬åˆ°AIå·¥å…·è¿›è¡Œå®è·µ</p>
                    </div>

                    <!-- ä»»åŠ¡ç®¡ç†éƒ¨åˆ† -->
                    <div class="form-group">
                        <label class="form-label">è¯¾ç¨‹ä»»åŠ¡</label>
                        <p class="form-hint">ä¸ºå­¦ç”Ÿæ·»åŠ å…·ä½“çš„å­¦ä¹ ä»»åŠ¡ï¼Œä¾‹å¦‚"ç»™DeepSeekå‘é€ä¸€æ®µè‡ªæˆ‘ä»‹ç»"</p>

                        <div id="tasksList" class="tasks-list">
                            <!-- ä»»åŠ¡åˆ—è¡¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        </div>

                        <button type="button" class="btn btn-secondary" id="addTaskBtn">
                            â• æ·»åŠ ä»»åŠ¡
                        </button>
                    </div>

                    <button type="submit" class="btn btn-primary" id="courseSubmitBtn" disabled>ä¿å­˜è¯¾ç¨‹</button>
                </form>
            </div>
        </div>
        
        <!-- ä½œä¸šç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="homework-tab">
            <!-- å¸ƒç½®ä½œä¸šè¡¨å• -->
            <div class="form-card">
                <h2 class="form-title">ğŸ“ å¸ƒç½®æ–°ä½œä¸š</h2>
                <form id="homeworkForm">
                    <div class="form-group">
                        <label class="form-label" for="homeworkTitle">ä½œä¸šæ ‡é¢˜ *</label>
                        <input type="text" id="homeworkTitle" class="form-input" 
                               placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨AIç”Ÿæˆä¸€å¼ é£æ™¯å›¾ç‰‡" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="homeworkDescription">ä½œä¸šè¦æ±‚ *</label>
                        <textarea id="homeworkDescription" class="form-textarea" 
                                  placeholder="è¯¦ç»†æè¿°ä½œä¸šè¦æ±‚ã€æäº¤æ ¼å¼ã€è¯„åˆ†æ ‡å‡†ç­‰..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="homeworkAILink">AIå·¥å…·é“¾æ¥</label>
                        <input type="url" id="homeworkAILink" class="form-input" 
                               placeholder="ä¾‹å¦‚ï¼šhttps://www.midjourney.com">
                        <p class="form-hint">å­¦ç”Ÿå¯ä»¥ä½¿ç”¨æ­¤AIå·¥å…·å®Œæˆä½œä¸š</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="homeworkDeadline">æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" id="homeworkDeadline" class="form-input">
                    </div>
                    
                    <button type="submit" class="btn btn-success">å¸ƒç½®ä½œä¸š</button>
                </form>
            </div>
        </div>

        <!-- ä½œä¸šç›‘æ§æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="homework-monitor-tab">
            <div class="form-card">
                <h2 class="form-title">ğŸ“Š ä½œä¸šæäº¤ç›‘æ§</h2>
                <p class="form-hint">æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿçš„ä½œä¸šæäº¤æƒ…å†µ</p>

                <!-- åˆ·æ–°æŒ‰é’® -->
                <button class="btn btn-primary" id="refreshHomeworkBtn" style="margin-bottom: 20px;">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>

                <!-- ä½œä¸šæäº¤ç»Ÿè®¡ -->
                <div id="homeworkStatsSection" style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“ˆ æäº¤ç»Ÿè®¡</h3>
                    <div id="homeworkStatsList"></div>
                </div>

                <!-- å­¦ç”Ÿä½œä¸šè¯¦æƒ… -->
                <div id="studentHomeworkSection">
                    <h3 style="margin-bottom: 15px;">ğŸ“‹ å­¦ç”Ÿä½œä¸šè¯¦æƒ…</h3>
                    <div id="studentHomeworkList"></div>
                </div>
            </div>
        </div>

        <!-- å­¦ç”Ÿè¿›åº¦ç›‘æ§æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="progress-tab">
            <div class="form-card">
                <h2 class="form-title">ğŸ“Š å­¦ç”Ÿè¿›åº¦ç›‘æ§</h2>
                <p class="form-hint">å®æ—¶æŸ¥çœ‹å­¦ç”Ÿå­¦ä¹ è¿›åº¦ï¼ŒåŠæ—¶å‘ç°éœ€è¦å¸®åŠ©çš„å­¦ç”Ÿ</p>

                <!-- åˆ·æ–°æŒ‰é’® -->
                <button class="btn btn-primary" id="refreshProgressBtn" style="margin-bottom: 20px;">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>

                <!-- å¡ä½çš„å­¦ç”Ÿè­¦æŠ¥ -->
                <div id="stuckStudentsSection" style="margin-bottom: 30px;">
                    <h3 style="color: var(--error-color); margin-bottom: 15px;">âš ï¸ éœ€è¦å¸®åŠ©çš„å­¦ç”Ÿ</h3>
                    <div id="stuckStudentsList"></div>
                </div>

                <!-- æ‰€æœ‰å­¦ç”Ÿè¿›åº¦ -->
                <div id="allProgressSection">
                    <h3 style="margin-bottom: 15px;">ğŸ“‹ æ‰€æœ‰å­¦ç”Ÿè¿›åº¦</h3>
                    <div id="allProgressList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== URLå‚æ•°å¤„ç† ====================
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');
        const courseId = urlParams.get('courseId');

        // æ ¹æ®actionå‚æ•°åˆ‡æ¢åˆ°ç›¸åº”çš„æ ‡ç­¾é¡µ
        if (action === 'homework') {
            // åˆ‡æ¢åˆ°ä½œä¸šç®¡ç†æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="homework"]').classList.add('active');
            document.getElementById('homework-tab').classList.add('active');
        } else if (action === 'edit' && courseId) {
            // ç¼–è¾‘è¯¾ç¨‹æ¨¡å¼ - åŠ è½½è¯¾ç¨‹æ•°æ®
            editCourse(courseId);
        }
        // action === 'create' æˆ–é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¾ç¤ºè¯¾ç¨‹ç®¡ç†æ ‡ç­¾é¡µï¼ˆé»˜è®¤å·²æ¿€æ´»ï¼‰

        // ==================== ä»»åŠ¡ç®¡ç† ====================
        let courseTasks = []; // å­˜å‚¨è¯¾ç¨‹ä»»åŠ¡åˆ—è¡¨

        // æ·»åŠ ä»»åŠ¡æŒ‰é’®äº‹ä»¶
        document.getElementById('addTaskBtn').addEventListener('click', () => {
            addNewTask();
        });

        // æ·»åŠ æ–°ä»»åŠ¡
        function addNewTask() {
            const taskId = `task_${Date.now()}`;
            const task = {
                taskId: taskId,
                taskType: 'ai_chat',
                taskTitle: '',
                taskDescription: '',
                taskParams: {
                    aiPlatform: 'DeepSeek',
                    promptTemplate: '',
                    expectedLength: '',
                    submissionType: 'text' // é»˜è®¤ä¸ºæ–‡å­—æäº¤
                },
                order: courseTasks.length + 1
            };

            courseTasks.push(task);
            renderTasks();
        }

        // åˆ é™¤ä»»åŠ¡
        function removeTask(taskId) {
            courseTasks = courseTasks.filter(t => t.taskId !== taskId);
            // é‡æ–°æ’åº
            courseTasks.forEach((task, index) => {
                task.order = index + 1;
            });
            renderTasks();
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';

            courseTasks.forEach((task, index) => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-header">
                        <span class="task-number">ä»»åŠ¡ ${index + 1}</span>
                        <button type="button" class="task-remove-btn" onclick="removeTask('${task.taskId}')">åˆ é™¤</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä»»åŠ¡æ ‡é¢˜</label>
                        <input type="text" class="form-input" value="${task.taskTitle}"
                               onchange="updateTaskField('${task.taskId}', 'taskTitle', this.value)"
                               placeholder="ä¾‹å¦‚ï¼šä¸AIè¿›è¡Œè‡ªæˆ‘ä»‹ç»">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä»»åŠ¡æè¿°</label>
                        <textarea class="form-textarea"
                                  onchange="updateTaskField('${task.taskId}', 'taskDescription', this.value)"
                                  placeholder="è¯¦ç»†æè¿°å­¦ç”Ÿéœ€è¦å®Œæˆçš„ä»»åŠ¡...">${task.taskDescription}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">AIå¹³å°</label>
                        <select class="form-input" onchange="updateTaskParam('${task.taskId}', 'aiPlatform', this.value)">
                            <option value="DeepSeek" ${task.taskParams.aiPlatform === 'DeepSeek' ? 'selected' : ''}>DeepSeek</option>
                            <option value="ChatGPT" ${task.taskParams.aiPlatform === 'ChatGPT' ? 'selected' : ''}>ChatGPT</option>
                            <option value="Claude" ${task.taskParams.aiPlatform === 'Claude' ? 'selected' : ''}>Claude</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æç¤ºè¯æ¨¡æ¿</label>
                        <input type="text" class="form-input" value="${task.taskParams.promptTemplate}"
                               onchange="updateTaskParam('${task.taskId}', 'promptTemplate', this.value)"
                               placeholder="ä¾‹å¦‚ï¼šä½ å¥½ï¼Œæˆ‘æ˜¯[ä½ çš„åå­—]...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æäº¤ç±»å‹</label>
                        <select class="form-input" onchange="updateTaskParam('${task.taskId}', 'submissionType', this.value)">
                            <option value="text" ${task.taskParams.submissionType === 'text' ? 'selected' : ''}>æ–‡å­—</option>
                            <option value="image" ${task.taskParams.submissionType === 'image' ? 'selected' : ''}>å›¾ç‰‡</option>
                            <option value="video" ${task.taskParams.submissionType === 'video' ? 'selected' : ''}>è§†é¢‘</option>
                            <option value="file" ${task.taskParams.submissionType === 'file' ? 'selected' : ''}>æ–‡ä»¶</option>
                        </select>
                        <p class="form-hint">é€‰æ‹©å­¦ç”Ÿæäº¤ä»»åŠ¡çš„æ–¹å¼</p>
                    </div>
                `;
                tasksList.appendChild(taskItem);
            });
        }

        // æ›´æ–°ä»»åŠ¡å­—æ®µ
        function updateTaskField(taskId, field, value) {
            const task = courseTasks.find(t => t.taskId === taskId);
            if (task) {
                task[field] = value;
            }
        }

        // æ›´æ–°ä»»åŠ¡å‚æ•°
        function updateTaskParam(taskId, param, value) {
            const task = courseTasks.find(t => t.taskId === taskId);
            if (task) {
                task.taskParams[param] = value;
            }
        }

        // ==================== è¿”å›æŒ‰é’® ====================
        const returnBtn = document.getElementById('returnBtn');
        if (returnBtn) {
            returnBtn.addEventListener('click', () => {
                window.location.href = 'course_selection.html?mode=teacher';
            });
        }

        // ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                btn.classList.add('active');
                const tabId = btn.dataset.tab + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // ==================== æ–‡ä»¶ä¸Šä¼ å¤„ç† ====================
        // è§†é¢‘æ–‡ä»¶ä¸Šä¼ 
        const videoUploadArea = document.getElementById('videoUploadArea');
        const courseVideoFile = document.getElementById('courseVideoFile');
        const videoFilePreview = document.getElementById('videoFilePreview');
        const videoFileName = document.getElementById('videoFileName');

        if (videoUploadArea && courseVideoFile) {
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            videoUploadArea.addEventListener('click', () => {
                courseVideoFile.click();
            });

            // æ–‡ä»¶é€‰æ‹©åæ˜¾ç¤ºé¢„è§ˆ
            courseVideoFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    videoFileName.textContent = file.name;
                    videoFilePreview.style.display = 'block';
                }
            });

            // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
            videoUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                videoUploadArea.style.borderColor = 'var(--accent-color)';
                videoUploadArea.style.backgroundColor = 'rgba(26, 115, 232, 0.05)';
            });

            videoUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                videoUploadArea.style.borderColor = 'var(--border-color)';
                videoUploadArea.style.backgroundColor = '';
            });

            videoUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                videoUploadArea.style.borderColor = 'var(--border-color)';
                videoUploadArea.style.backgroundColor = '';

                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    courseVideoFile.files = e.dataTransfer.files;
                    videoFileName.textContent = file.name;
                    videoFilePreview.style.display = 'block';
                } else {
                    alert('è¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶');
                }
            });
        }

        // å­—å¹•æ–‡ä»¶ä¸Šä¼ 
        const subtitleUploadArea = document.getElementById('subtitleUploadArea');
        const courseSubtitleFile = document.getElementById('courseSubtitleFile');
        const subtitleFilePreview = document.getElementById('subtitleFilePreview');
        const subtitleFileName = document.getElementById('subtitleFileName');

        if (subtitleUploadArea && courseSubtitleFile) {
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            subtitleUploadArea.addEventListener('click', () => {
                courseSubtitleFile.click();
            });

            // æ–‡ä»¶é€‰æ‹©åæ˜¾ç¤ºé¢„è§ˆ
            courseSubtitleFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    subtitleFileName.textContent = file.name;
                    subtitleFilePreview.style.display = 'block';
                }
            });

            // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
            subtitleUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                subtitleUploadArea.style.borderColor = 'var(--accent-color)';
                subtitleUploadArea.style.backgroundColor = 'rgba(26, 115, 232, 0.05)';
            });

            subtitleUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                subtitleUploadArea.style.borderColor = 'var(--border-color)';
                subtitleUploadArea.style.backgroundColor = '';
            });

            subtitleUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                subtitleUploadArea.style.borderColor = 'var(--border-color)';
                subtitleUploadArea.style.backgroundColor = '';

                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.vtt') || file.name.endsWith('.srt'))) {
                    courseSubtitleFile.files = e.dataTransfer.files;
                    subtitleFileName.textContent = file.name;
                    subtitleFilePreview.style.display = 'block';
                } else {
                    alert('è¯·ä¸Šä¼ VTTæˆ–SRTæ ¼å¼çš„å­—å¹•æ–‡ä»¶');
                }
            });
        }

        // ==================== å­—å¹•æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ ====================
        async function uploadSubtitleFile(subtitleFile) {
            try {
                const formData = new FormData();
                formData.append('subtitle', subtitleFile);

                const uploadResponse = await fetch('http://localhost:3000/api/upload/subtitle', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error('å­—å¹•ä¸Šä¼ å¤±è´¥');
                }

                const uploadResult = await uploadResponse.json();

                if (uploadResult.success) {
                    return uploadResult.subtitleUrl;
                } else {
                    return null;
                }
            } catch (error) {
                console.error('å­—å¹•ä¸Šä¼ å¤±è´¥:', error);
                return null;
            }
        }

        // ==================== å­—å¹•ç”ŸæˆåŠŸèƒ½ ====================
        async function generateSubtitlesForVideo(videoUrl) {
            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°æ–‡ä»¶è·¯å¾„
                const isLocalFile = videoUrl.startsWith('data/') ||
                                   videoUrl.includes('localhost') ||
                                   !videoUrl.startsWith('http://') && !videoUrl.startsWith('https://');

                if (isLocalFile) {
                    console.warn('[å­—å¹•ç”Ÿæˆ] æ£€æµ‹åˆ°æœ¬åœ°æ–‡ä»¶ï¼ŒAssemblyAI æ— æ³•è®¿é—®æœ¬åœ°æ–‡ä»¶');
                    throw new Error('æœ¬åœ°è§†é¢‘æ–‡ä»¶æ— æ³•è‡ªåŠ¨ç”Ÿæˆå­—å¹•ã€‚AssemblyAI éœ€è¦å…¬å¼€å¯è®¿é—®çš„è§†é¢‘ URLã€‚è¯·æ‰‹åŠ¨ä¸Šä¼ å­—å¹•æ–‡ä»¶ã€‚');
                }

                // æäº¤è½¬å½•ä»»åŠ¡
                const submitResponse = await fetch('http://localhost:3000/api/subtitles/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoUrl: videoUrl,
                        courseId: 'temp_' + Date.now(), // ä¸´æ—¶è¯¾ç¨‹ID
                        language: 'zh'
                    })
                });

                if (!submitResponse.ok) {
                    throw new Error('æäº¤è½¬å½•ä»»åŠ¡å¤±è´¥');
                }

                const submitData = await submitResponse.json();
                const transcriptId = submitData.transcriptId;

                // è½®è¯¢æ£€æŸ¥è½¬å½•çŠ¶æ€
                let completed = false;
                let attempts = 0;
                const maxAttempts = 60; // æœ€å¤šç­‰å¾…3åˆ†é’Ÿï¼ˆæ¯3ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰

                while (!completed && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 3000)); // ç­‰å¾…3ç§’

                    const statusResponse = await fetch(`http://localhost:3000/api/subtitles/status/${transcriptId}`);
                    if (!statusResponse.ok) {
                        throw new Error('æ£€æŸ¥è½¬å½•çŠ¶æ€å¤±è´¥');
                    }

                    const statusData = await statusResponse.json();

                    if (statusData.status === 'completed') {
                        completed = true;
                    } else if (statusData.status === 'error') {
                        throw new Error('è½¬å½•å¤±è´¥');
                    }

                    attempts++;
                }

                if (!completed) {
                    throw new Error('è½¬å½•è¶…æ—¶');
                }

                // ç”ŸæˆVTTæ–‡ä»¶
                const vttResponse = await fetch('http://localhost:3000/api/subtitles/to-vtt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transcriptId: transcriptId,
                        courseId: 'temp_' + Date.now()
                    })
                });

                if (!vttResponse.ok) {
                    throw new Error('ç”ŸæˆVTTæ–‡ä»¶å¤±è´¥');
                }

                const vttData = await vttResponse.json();
                return vttData.filePath; // è¿”å›å­—å¹•æ–‡ä»¶è·¯å¾„

            } catch (error) {
                console.error('ç”Ÿæˆå­—å¹•å¤±è´¥:', error);
                return null;
            }
        }

        // ==================== è¯¾ç¨‹è¡¨å•æäº¤ ====================
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // æ£€æŸ¥æ˜¯å¦æœ‰è§†é¢‘æ–‡ä»¶
            const videoFile = document.getElementById('courseVideoFile').files[0];
            const subtitleFile = document.getElementById('courseSubtitleFile').files[0];
            let videoUrl = '';
            let subtitleUrl = '';

            // å¦‚æœæœ‰è§†é¢‘æ–‡ä»¶ï¼Œå…ˆä¸Šä¼ è§†é¢‘
            if (videoFile) {
                try {
                    const formData = new FormData();
                    formData.append('video', videoFile);

                    const uploadResponse = await fetch('http://localhost:3000/api/upload/video', {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('è§†é¢‘ä¸Šä¼ ç«¯ç‚¹ä¸å¯ç”¨ã€‚è¯·è”ç³»ç®¡ç†å‘˜é…ç½®è§†é¢‘ä¸Šä¼ åŠŸèƒ½ã€‚');
                    }

                    const uploadResult = await uploadResponse.json();

                    if (uploadResult.success) {
                        videoUrl = uploadResult.videoUrl;
                        alert('è§†é¢‘ä¸Šä¼ æˆåŠŸï¼');

                        // æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨ä¸Šä¼ çš„å­—å¹•æ–‡ä»¶
                        if (subtitleFile) {
                            // ä¸Šä¼ å­—å¹•æ–‡ä»¶
                            alert('æ­£åœ¨ä¸Šä¼ å­—å¹•æ–‡ä»¶...');
                            subtitleUrl = await uploadSubtitleFile(subtitleFile);

                            if (subtitleUrl) {
                                alert('å­—å¹•ä¸Šä¼ æˆåŠŸï¼');
                            } else {
                                alert('å­—å¹•ä¸Šä¼ å¤±è´¥ã€‚');
                            }
                        } else {
                            // æ²¡æœ‰æ‰‹åŠ¨ä¸Šä¼ å­—å¹•ï¼Œæç¤ºç”¨æˆ·
                            alert('æç¤ºï¼šæœ¬åœ°è§†é¢‘æ–‡ä»¶æ— æ³•è‡ªåŠ¨ç”Ÿæˆå­—å¹•ã€‚\n\nAssemblyAI éœ€è¦å…¬å¼€å¯è®¿é—®çš„è§†é¢‘ URLï¼ˆå¦‚ YouTubeã€äº‘å­˜å‚¨é“¾æ¥ï¼‰æ‰èƒ½è‡ªåŠ¨ç”Ÿæˆå­—å¹•ã€‚\n\nå¦‚éœ€å­—å¹•ï¼Œè¯·ï¼š\n1. æ‰‹åŠ¨ä¸Šä¼ å­—å¹•æ–‡ä»¶ï¼ˆVTT æˆ– SRT æ ¼å¼ï¼‰ï¼Œæˆ–\n2. ä½¿ç”¨å…¬å¼€å¯è®¿é—®çš„è§†é¢‘é“¾æ¥\n\nè¯¾ç¨‹å°†ç»§ç»­åˆ›å»ºï¼Œä½†ä¸åŒ…å«å­—å¹•ã€‚');
                        }
                    } else {
                        alert('è§†é¢‘ä¸Šä¼ å¤±è´¥ï¼š' + uploadResult.message);
                        return;
                    }
                } catch (error) {
                    console.error('è§†é¢‘ä¸Šä¼ å¤±è´¥:', error);
                    alert('è§†é¢‘ä¸Šä¼ åŠŸèƒ½æš‚ä¸å¯ç”¨ã€‚\n\n' + error.message + '\n\nå°†ç»§ç»­åˆ›å»ºè¯¾ç¨‹ï¼Œä½†ä¸åŒ…å«è§†é¢‘ã€‚');
                    // ç»§ç»­åˆ›å»ºè¯¾ç¨‹ï¼Œä½†ä¸åŒ…å«è§†é¢‘
                }
            }

            const courseData = {
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                content: document.getElementById('courseContent').value,
                aiToolLinks: [],
                tasks: courseTasks, // åŒ…å«ä»»åŠ¡æ•°æ®
                createdBy: 'teacher_001'
            };

            // åªåœ¨æœ‰æ–°è§†é¢‘ä¸Šä¼ æ—¶æ‰è®¾ç½®videoUrlï¼Œå¦åˆ™ä¿æŒåŸæœ‰è§†é¢‘
            if (videoUrl) {
                courseData.videoUrl = videoUrl;
                // å¦‚æœç”Ÿæˆäº†å­—å¹•ï¼Œä¹Ÿä¿å­˜å­—å¹•URL
                if (subtitleUrl) {
                    courseData.subtitleUrl = subtitleUrl;
                }
            } else if (!currentEditingCourseId) {
                // åˆ›å»ºæ–°è¯¾ç¨‹æ—¶ï¼Œå¦‚æœæ²¡æœ‰è§†é¢‘åˆ™è®¾ä¸ºç©ºå­—ç¬¦ä¸²
                courseData.videoUrl = '';
            }
            // ç¼–è¾‘æ—¶å¦‚æœæ²¡æœ‰æ–°è§†é¢‘ï¼Œä¸è®¾ç½®videoUrlå­—æ®µï¼Œè®©æœåŠ¡å™¨ä¿ç•™åŸå€¼

            // å¦‚æœæœ‰AIé“¾æ¥ï¼Œæ·»åŠ åˆ°aiToolLinksæ•°ç»„
            const aiLink = document.getElementById('courseAILink').value;
            if (aiLink) {
                courseData.aiToolLinks.push({
                    name: 'AIå·¥å…·',
                    url: aiLink
                });
            }

            try {
                // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è¦ç¼–è¾‘çš„è¯¾ç¨‹
                if (!currentEditingCourseId) {
                    alert('è¯·å…ˆåˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªè¯¾ç¨‹è¿›è¡Œç¼–è¾‘');
                    return;
                }

                // å§‹ç»ˆä½¿ç”¨PUTæ–¹æ³•æ›´æ–°è¯¾ç¨‹
                const response = await fetch(`http://localhost:3000/api/courses/${currentEditingCourseId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('è¯¾ç¨‹ä¿å­˜æˆåŠŸï¼\n\nè¯¾ç¨‹æ ‡é¢˜ï¼š' + courseData.title + '\nä»»åŠ¡æ•°é‡ï¼š' + courseTasks.length);

                    // åˆ·æ–°è¯¾ç¨‹åˆ—è¡¨
                    await loadExistingCourses();

                    // ä¿æŒåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œé‡æ–°åŠ è½½å½“å‰è¯¾ç¨‹
                    await editCourse(currentEditingCourseId);
                } else {
                    alert('è¯¾ç¨‹ä¿å­˜å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜è¯¾ç¨‹æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜è¯¾ç¨‹å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨å·²å¯åŠ¨ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
            }
        });
        
        // ==================== ä½œä¸šè¡¨å•æäº¤ ====================
        document.getElementById('homeworkForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // ç”Ÿæˆå”¯ä¸€çš„ä½œä¸šID
            const homeworkId = 'hw_' + Date.now();

            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            const homeworkData = {
                id: homeworkId,
                title: document.getElementById('homeworkTitle').value,
                description: document.getElementById('homeworkDescription').value,
                aiToolLinks: document.getElementById('homeworkAILink').value ? [
                    {
                        name: 'AIå·¥å…·',
                        url: document.getElementById('homeworkAILink').value
                    }
                ] : [],
                deadline: document.getElementById('homeworkDeadline').value ?
                    new Date(document.getElementById('homeworkDeadline').value).toISOString() : null,
                createdAt: new Date().toISOString(),
                createdBy: currentUser ? currentUser.id : 'teacher_001',
                status: 'active'
            };

            try {
                const response = await fetch('http://localhost:3000/api/homework', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(homeworkData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('ä½œä¸šå¸ƒç½®æˆåŠŸï¼\n\nä½œä¸šæ ‡é¢˜ï¼š' + homeworkData.title);
                    // é‡ç½®è¡¨å•
                    e.target.reset();
                } else {
                    alert('ä½œä¸šå¸ƒç½®å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('å¸ƒç½®ä½œä¸šå¤±è´¥:', error);
                alert('ä½œä¸šå¸ƒç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        });

        // ==================== ä½œä¸šç›‘æ§åŠŸèƒ½ ====================
        // è·å–æ‰€æœ‰ä½œä¸šæäº¤æƒ…å†µ
        async function loadHomeworkSubmissions() {
            try {
                // è·å–æ‰€æœ‰ä½œä¸š
                const homeworkResponse = await fetch('http://localhost:3000/api/homework');
                const homeworkData = await homeworkResponse.json();

                // è·å–æ‰€æœ‰ä½œä¸šæäº¤è®°å½•ï¼ˆä»æœåŠ¡å™¨APIè·å–ï¼‰
                const submissionsResponse = await fetch('http://localhost:3000/api/submissions');
                const submissionsData = await submissionsResponse.json();

                // å°†æäº¤è®°å½•æ•°ç»„è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼ï¼ˆä¸ºäº†å…¼å®¹ç°æœ‰ä»£ç ï¼‰
                const submissions = {};
                if (submissionsData.success && submissionsData.submissions) {
                    submissionsData.submissions.forEach(sub => {
                        submissions[sub.id] = sub;
                    });
                }

                if (homeworkData.success && homeworkData.homework) {
                    displayHomeworkStats(homeworkData.homework, submissions);
                    displayStudentHomework(homeworkData.homework, submissions);
                }
            } catch (error) {
                console.error('è·å–ä½œä¸šæäº¤æƒ…å†µå¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºä½œä¸šç»Ÿè®¡
        function displayHomeworkStats(homeworkList, submissions) {
            const container = document.getElementById('homeworkStatsList');

            if (homeworkList.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— ä½œä¸š</p>';
                return;
            }

            let html = '<ul class="item-list">';
            homeworkList.forEach(hw => {
                // ç»Ÿè®¡è¯¥ä½œä¸šçš„æäº¤æƒ…å†µ
                const submittedCount = Object.values(submissions).filter(
                    sub => sub.homeworkId === hw.id
                ).length;

                const statusColor = submittedCount > 0 ? 'var(--success-color)' : 'var(--warning-color)';

                html += `
                    <li class="item-card">
                        <div class="item-header">
                            <span class="item-title">${hw.title}</span>
                            <span style="color: ${statusColor}; font-weight: 600;">
                                ${submittedCount} äººå·²æäº¤
                            </span>
                        </div>
                        <div class="item-content">
                            ${hw.description}
                        </div>
                        <div class="item-meta">
                            æˆªæ­¢æ—¥æœŸ: ${hw.deadline ? new Date(hw.deadline).toLocaleDateString('zh-CN') : 'æ— '}
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºå­¦ç”Ÿä½œä¸šè¯¦æƒ…
        function displayStudentHomework(homeworkList, submissions) {
            const container = document.getElementById('studentHomeworkList');

            const submissionArray = Object.entries(submissions);

            if (submissionArray.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— å­¦ç”Ÿæäº¤ä½œä¸š</p>';
                return;
            }

            let html = '<ul class="item-list">';
            submissionArray.forEach(([submissionId, submission]) => {
                const homework = homeworkList.find(hw => hw.id === submission.homeworkId);
                const homeworkTitle = homework ? homework.title : 'æœªçŸ¥ä½œä¸š';

                // åˆ¤æ–­æ˜¯å¦æœ‰æ–‡ä»¶
                const hasFile = submission.fileUrl && submission.fileUrl !== 'çº¯æ–‡å­—æäº¤';
                const fileButtons = hasFile ? `
                    <button class="btn btn-primary" onclick="viewSubmissionFile('${submission.fileUrl}', '${submission.fileName || ''}', '${submission.mimetype || ''}')">
                        ğŸ‘ï¸ æŸ¥çœ‹æ–‡ä»¶
                    </button>
                    <button class="btn btn-secondary" onclick="downloadSubmissionFile('${submission.fileUrl}', '${submission.fileName || ''}')">
                        ğŸ“¥ ä¸‹è½½æ–‡ä»¶
                    </button>
                ` : '';

                html += `
                    <li class="item-card">
                        <div class="item-header">
                            <div>
                                <span class="item-title">å­¦ç”ŸID: ${submission.studentId || 'æœªçŸ¥'}</span>
                                <span style="color: var(--text-secondary); margin-left: 10px;">ä½œä¸š: ${homeworkTitle}</span>
                            </div>
                            <span style="color: var(--success-color); font-weight: 600;">âœ“ å·²æäº¤</span>
                        </div>
                        <div class="item-content">
                            <strong>ä½œä¸šè¯´æ˜ï¼š</strong>${submission.note || 'æ— '}
                        </div>
                        <div class="item-meta">
                            æ–‡ä»¶: ${submission.fileName || 'çº¯æ–‡å­—æäº¤'} |
                            æäº¤æ—¶é—´: ${formatDateTime(submission.submittedAt)}
                        </div>
                        ${hasFile ? `<div class="item-actions" style="margin-top: 12px; display: flex; gap: 8px;">
                            ${fileButtons}
                        </div>` : ''}
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // æŸ¥çœ‹æäº¤çš„æ–‡ä»¶
        function viewSubmissionFile(fileUrl, fileName, mimetype) {
            if (!fileUrl) {
                alert('æ–‡ä»¶ä¸å­˜åœ¨');
                return;
            }

            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºæ–‡ä»¶
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'âœ• å…³é—­';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                z-index: 10001;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);

            const content = document.createElement('div');
            content.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                background-color: white;
                border-radius: 8px;
                padding: 20px;
                overflow: auto;
            `;

            // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒçš„å†…å®¹
            if (mimetype && mimetype.startsWith('image/')) {
                // å›¾ç‰‡é¢„è§ˆ
                const img = document.createElement('img');
                img.src = fileUrl;
                img.style.cssText = 'max-width: 100%; max-height: 80vh; object-fit: contain;';
                content.appendChild(img);
            } else if (mimetype && mimetype.startsWith('video/')) {
                // è§†é¢‘é¢„è§ˆ
                const video = document.createElement('video');
                video.src = fileUrl;
                video.controls = true;
                video.style.cssText = 'max-width: 100%; max-height: 80vh;';
                content.appendChild(video);
            } else if (fileName && (fileName.endsWith('.html') || fileName.endsWith('.htm'))) {
                // HTMLæ–‡ä»¶é¢„è§ˆ
                const iframe = document.createElement('iframe');
                iframe.src = fileUrl;
                iframe.style.cssText = 'width: 100%; height: 80vh; border: none;';
                content.appendChild(iframe);
            } else {
                // å…¶ä»–æ–‡ä»¶ç±»å‹ï¼Œæ˜¾ç¤ºä¸‹è½½é“¾æ¥
                content.innerHTML = `
                    <h3>æ–‡ä»¶: ${fileName}</h3>
                    <p>æ­¤æ–‡ä»¶ç±»å‹æ— æ³•é¢„è§ˆï¼Œè¯·ä¸‹è½½æŸ¥çœ‹ã€‚</p>
                    <a href="${fileUrl}" download="${fileName}" class="btn btn-primary">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</a>
                `;
            }

            modal.appendChild(closeBtn);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // ä¸‹è½½æäº¤çš„æ–‡ä»¶
        function downloadSubmissionFile(fileUrl, fileName) {
            if (!fileUrl) {
                alert('æ–‡ä»¶ä¸å­˜åœ¨');
                return;
            }

            const a = document.createElement('a');
            a.href = fileUrl;
            a.download = fileName || 'homework_file';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ==================== å­¦ç”Ÿè¿›åº¦ç›‘æ§ ====================
        // è·å–æ‰€æœ‰å­¦ç”Ÿè¿›åº¦
        async function loadAllProgress() {
            try {
                const response = await fetch('http://localhost:3000/api/progress/all');
                const data = await response.json();

                if (data.success) {
                    displayAllProgress(data.progress);
                }
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿè¿›åº¦å¤±è´¥:', error);
            }
        }

        // è·å–å¡ä½çš„å­¦ç”Ÿ
        async function loadStuckStudents() {
            try {
                const response = await fetch('http://localhost:3000/api/progress/stuck');
                const data = await response.json();

                if (data.success) {
                    displayStuckStudents(data.stuckStudents);
                }
            } catch (error) {
                console.error('è·å–å¡ä½å­¦ç”Ÿå¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå¡ä½çš„å­¦ç”Ÿ
        function displayStuckStudents(stuckStudents) {
            const container = document.getElementById('stuckStudentsList');

            if (stuckStudents.length === 0) {
                container.innerHTML = '<p style="color: var(--success-color);">âœ… ç›®å‰æ²¡æœ‰å­¦ç”Ÿéœ€è¦å¸®åŠ©</p>';
                return;
            }

            let html = '<ul class="item-list">';
            stuckStudents.forEach(progress => {
                const stuckTime = calculateTimeDiff(progress.lastActivity);
                html += `
                    <li class="item-card" style="border-left: 4px solid var(--error-color);">
                        <div class="item-header">
                            <div>
                                <span class="item-title">å­¦ç”ŸID: ${progress.studentId}</span>
                                <span style="color: var(--text-secondary); margin-left: 10px;">è¯¾ç¨‹: ${progress.courseId}</span>
                            </div>
                        </div>
                        <div class="item-content">
                            <strong>å¡åœ¨ä»»åŠ¡ ${progress.taskIndex + 1}</strong> - å·²åœç•™ ${stuckTime}
                        </div>
                        <div class="item-meta">
                            è®¿é—®æ¬¡æ•°: ${progress.visitCount || 1} æ¬¡ | æœ€åæ´»åŠ¨: ${formatDateTime(progress.lastActivity)}
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿè¿›åº¦
        function displayAllProgress(progressList) {
            const container = document.getElementById('allProgressList');

            if (progressList.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— å­¦ç”Ÿè¿›åº¦æ•°æ®</p>';
                return;
            }

            let html = '<ul class="item-list">';
            progressList.forEach(progress => {
                const statusColor = progress.completed ? 'var(--success-color)' : 'var(--warning-color)';
                const statusText = progress.completed ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­';
                const timeDiff = calculateTimeDiff(progress.lastActivity);

                html += `
                    <li class="item-card">
                        <div class="item-header">
                            <div>
                                <span class="item-title">å­¦ç”ŸID: ${progress.studentId}</span>
                                <span style="color: ${statusColor}; margin-left: 10px;">${statusText}</span>
                            </div>
                        </div>
                        <div class="item-content">
                            è¯¾ç¨‹: ${progress.courseId} | ä»»åŠ¡ ${progress.taskIndex + 1}
                        </div>
                        <div class="item-meta">
                            å¼€å§‹æ—¶é—´: ${formatDateTime(progress.startTime)} |
                            æœ€åæ´»åŠ¨: ${formatDateTime(progress.lastActivity)} (${timeDiff}å‰) |
                            è®¿é—®æ¬¡æ•°: ${progress.visitCount || 1} æ¬¡
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // è®¡ç®—æ—¶é—´å·®
        function calculateTimeDiff(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿ`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}å°æ—¶`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}å¤©`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ³¨æ„ï¼šåˆ·æ–°æŒ‰é’®å’Œæ ‡ç­¾é¡µåˆ‡æ¢çš„äº‹ä»¶ç›‘å¬å™¨å·²ç§»åˆ° DOMContentLoaded ä¸­

        // ==================== è¯¾ç¨‹ç®¡ç†åŠŸèƒ½ ====================
        let currentEditingCourseId = null;

        // åˆ›å»ºæ–°çš„ç©ºç™½è¯¾ç¨‹
        async function createNewEmptyCourse() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));

                const emptyCourseData = {
                    title: 'æ–°è¯¾ç¨‹ï¼ˆæœªå‘½åï¼‰',
                    description: 'è¯·ç¼–è¾‘è¯¾ç¨‹æè¿°',
                    content: '',
                    videoUrl: '',
                    aiToolLinks: [],
                    tasks: [],
                    createdBy: currentUser ? currentUser.id : 'teacher_001'
                };

                const response = await fetch('http://localhost:3000/api/courses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emptyCourseData)
                });

                const result = await response.json();

                if (result.success) {
                    const newCourse = result.course;

                    // åˆ·æ–°è¯¾ç¨‹åˆ—è¡¨
                    await loadExistingCourses();

                    // è‡ªåŠ¨åŠ è½½æ–°è¯¾ç¨‹åˆ°ç¼–è¾‘è¡¨å•
                    await editCourse(newCourse.id);

                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    alert('æ–°è¯¾ç¨‹å·²åˆ›å»ºï¼\n\nè¯·åœ¨ä¸‹æ–¹ç¼–è¾‘è¯¾ç¨‹å†…å®¹ã€‚');
                } else {
                    alert('åˆ›å»ºè¯¾ç¨‹å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ›å»ºç©ºç™½è¯¾ç¨‹å¤±è´¥:', error);
                alert('åˆ›å»ºè¯¾ç¨‹å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨å·²å¯åŠ¨ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
            }
        }

        // ç»‘å®šåˆ›å»ºæ–°è¯¾ç¨‹æŒ‰é’®äº‹ä»¶
        document.getElementById('createNewCourseBtn').addEventListener('click', () => {
            createNewEmptyCourse();
        });

        // åŠ è½½ç°æœ‰è¯¾ç¨‹åˆ—è¡¨
        async function loadExistingCourses() {
            try {
                const response = await fetch('http://localhost:3000/api/courses');
                const data = await response.json();

                const container = document.getElementById('existingCoursesList');

                if (data.success && data.courses) {
                    if (data.courses.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">æš‚æ— è¯¾ç¨‹</p>';
                        return;
                    }

                    let html = '<ul class="item-list">';
                    data.courses.forEach(course => {
                        const hasVideo = course.videoUrl && course.videoUrl.trim() !== '';
                        const taskCount = course.tasks ? course.tasks.length : 0;
                        const videoStatus = hasVideo ? 'âœ… æœ‰è§†é¢‘' : 'âŒ æ— è§†é¢‘';
                        const videoColor = hasVideo ? 'var(--success-color)' : 'var(--text-secondary)';

                        html += `
                            <li class="item-card">
                                <div class="item-header">
                                    <span class="item-title">${course.title}</span>
                                    <div class="item-actions">
                                        <button class="btn btn-secondary" onclick="editCourse('${course.id}')">
                                            âœï¸ ç¼–è¾‘
                                        </button>
                                        <button class="btn btn-secondary" onclick="deleteCourse('${course.id}', '${course.title.replace(/'/g, "\\'")}')">
                                            ğŸ—‘ï¸ åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                                <div class="item-content">
                                    ${course.description}
                                </div>
                                <div class="item-meta">
                                    <span style="color: ${videoColor};">${videoStatus}</span> |
                                    ä»»åŠ¡æ•°: ${taskCount} |
                                    åˆ›å»ºæ—¶é—´: ${formatDateTime(course.createdAt)}
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: var(--error-color); text-align: center;">åŠ è½½è¯¾ç¨‹å¤±è´¥</p>';
                }
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥:', error);
                const container = document.getElementById('existingCoursesList');
                container.innerHTML = '<p style="color: var(--error-color); text-align: center;">åŠ è½½è¯¾ç¨‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡</p>';
            }
        }

        // åˆ é™¤è¯¾ç¨‹
        async function deleteCourse(courseId, courseTitle) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è¯¾ç¨‹"${courseTitle}"å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/courses/${courseId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('è¯¾ç¨‹åˆ é™¤æˆåŠŸï¼');
                    // é‡æ–°åŠ è½½è¯¾ç¨‹åˆ—è¡¨
                    await loadExistingCourses();
                } else {
                    alert('åˆ é™¤è¯¾ç¨‹å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤è¯¾ç¨‹å¤±è´¥:', error);
                alert('åˆ é™¤è¯¾ç¨‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ç¼–è¾‘è¯¾ç¨‹
        async function editCourse(courseId) {
            try {
                const response = await fetch(`http://localhost:3000/api/courses/${courseId}`);
                const data = await response.json();

                if (data.success) {
                    const course = data.course;

                    // å¡«å……è¡¨å•
                    document.getElementById('courseTitle').value = course.title;
                    document.getElementById('courseDescription').value = course.description;
                    document.getElementById('courseContent').value = course.content || '';

                    // æ˜¾ç¤ºç°æœ‰è§†é¢‘ä¿¡æ¯ï¼ˆæ–‡ä»¶è¾“å…¥æ¡†æ— æ³•é¢„å¡«å……ï¼‰
                    if (course.videoUrl) {
                        videoFilePreview.style.display = 'block';
                        videoFileName.textContent = 'å½“å‰è§†é¢‘: ' + course.videoUrl.split('/').pop();
                    }

                    // æ­£ç¡®æå–AIå·¥å…·é“¾æ¥
                    document.getElementById('courseAILink').value = course.aiToolLinks && course.aiToolLinks.length > 0 ? course.aiToolLinks[0].url : '';

                    // åŠ è½½ä»»åŠ¡åˆ—è¡¨
                    courseTasks = [];
                    if (course.tasks && course.tasks.length > 0) {
                        // å°†è¯¾ç¨‹çš„ä»»åŠ¡æ·»åŠ åˆ°courseTasksæ•°ç»„
                        courseTasks = course.tasks.map(task => ({
                            taskId: task.taskId || `task_${Date.now()}_${Math.random()}`,
                            taskType: task.taskType || 'ai_chat',
                            taskTitle: task.taskTitle || '',
                            taskDescription: task.taskDescription || '',
                            taskParams: task.taskParams || {
                                aiPlatform: 'DeepSeek',
                                promptTemplate: '',
                                expectedLength: ''
                            },
                            order: task.order || 0
                        }));
                    }
                    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                    renderTasks();

                    // æ›´æ–°è¡¨å•æ ‡é¢˜å’Œæç¤º
                    document.getElementById('courseFormTitle').textContent = 'âœï¸ ç¼–è¾‘è¯¾ç¨‹';
                    document.getElementById('courseFormHint').textContent = 'æ­£åœ¨ç¼–è¾‘ï¼š' + course.title;
                    document.getElementById('courseFormHint').style.color = 'var(--success-color)';

                    // å¯ç”¨ä¿å­˜æŒ‰é’®
                    document.getElementById('courseSubmitBtn').disabled = false;

                    // è®¾ç½®å½“å‰ç¼–è¾‘çš„è¯¾ç¨‹ID
                    currentEditingCourseId = courseId;

                    // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
                    const formCard = document.querySelector('#courseForm').closest('.form-card');
                    if (formCard) {
                        formCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else {
                    alert('åŠ è½½è¯¾ç¨‹å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
                alert('åŠ è½½è¯¾ç¨‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ==================== é¡µé¢åˆå§‹åŒ–å’Œè‡ªåŠ¨åˆ·æ–° ====================
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–å¡ä½çš„å­¦ç”Ÿä¿¡æ¯
        async function initializeDashboard() {
            // åŠ è½½å¡ä½çš„å­¦ç”Ÿ
            await loadStuckStudents();
            // åŠ è½½æ‰€æœ‰å­¦ç”Ÿè¿›åº¦
            await loadAllProgress();
        }

        // è‡ªåŠ¨åˆ·æ–°å¡ä½çš„å­¦ç”Ÿä¿¡æ¯ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
        function startAutoRefresh() {
            setInterval(async () => {
                // åªåœ¨è¿›åº¦ç›‘æ§æ ‡ç­¾é¡µæ¿€æ´»æ—¶è‡ªåŠ¨åˆ·æ–°
                const progressTab = document.querySelector('[data-tab="progress"]');
                if (progressTab && progressTab.classList.contains('active')) {
                    await loadStuckStudents();
                    await loadAllProgress();
                }
            }, 30000); // 30ç§’
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // ç»‘å®šåˆ·æ–°æŒ‰é’®äº‹ä»¶
            const refreshBtn = document.getElementById('refreshProgressBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    await loadStuckStudents();
                    await loadAllProgress();
                });
            }

            // ç»‘å®šä½œä¸šç›‘æ§åˆ·æ–°æŒ‰é’®äº‹ä»¶
            const refreshHomeworkBtn = document.getElementById('refreshHomeworkBtn');
            if (refreshHomeworkBtn) {
                refreshHomeworkBtn.addEventListener('click', async () => {
                    await loadHomeworkSubmissions();
                });
            }

            // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (btn.dataset.tab === 'progress') {
                        await loadStuckStudents();
                        await loadAllProgress();
                    } else if (btn.dataset.tab === 'courses') {
                        await loadExistingCourses();
                    } else if (btn.dataset.tab === 'homework-monitor') {
                        await loadHomeworkSubmissions();
                    }
                });
            });

            // åˆå§‹åŒ–ä»ªè¡¨æ¿
            initializeDashboard();
            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
            startAutoRefresh();
        });
    </script>
</body>
</html>
